name: CI

on:
  push:
  pull_request:

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release
  WX_VERSION: '3.2.4'

jobs:
  build-ubuntu:
    # The CMake configure and build commands are platform agnostic and should work equally well on Windows or Mac.
    # You can convert this to a matrix build if you need cross-platform coverage.
    # See: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
    runs-on: ubuntu-latest
    strategy:
        matrix:
            python-version: [ 3.10 ]

    steps:
    - name: Setup cmake
      uses: jwlawson/actions-setup-cmake@v1.12
      with:
        cmake-version: '3.24.x'
    - name: Set relative paths
      run: | 
        LKDIR=$GITHUB_WORKSPACE/lk
        echo "LKDIR=$LKDIR" >> $GITHUB_ENV
        WEXDIR=$GITHUB_WORKSPACE/wex
        echo "WEXDIR=$WEXDIR" >> $GITHUB_ENV
        SSCDIR=$GITHUB_WORKSPACE/ssc
        echo "SSCDIR=$SSCDIR" >> $GITHUB_ENV
        RAPIDJSONDIR=$GITHUB_WORKSPACE/ssc
        echo "RAPIDJSONDIR=$RAPIDJSONDIR" >> $GITHUB_ENV
        SAMNTDIR=$GITHUB_WORKSPACE/sam
        echo "SAMNTDIR=$SAMNTDIR" >> $GITHUB_ENV
    - name: Install Dependencies
      run: |
        sudo apt-get update --fix-missing
        sudo apt-get install -y \
          freeglut3-dev \
          libcurl4-openssl-dev \
          libfontconfig-dev \
          libgl1-mesa-dev \
          libgtk2.0-dev \
          mesa-common-dev \
          unzip

    - name: Set relative paths
      run: | 
        WXMSW3=$HOME/wx-$WX_VERSION
        echo "WXMSW3=$WXMSW3" >> $GITHUB_ENV
    - name: Get cached build of wxWidgets
      uses: actions/cache@v4
      id: cachedwx
      with:
        path: ${{env.WXMSW3}}/
        key: wxWidgets-${{ env.WX_VERSION }}-linux
    - name: Install wxWidgets
      if: steps.cachedwx.outputs.cache-hit != 'true'
      run: |
        curl -L https://github.com/wxWidgets/wxWidgets/releases/download/v$WX_VERSION/wxWidgets-$WX_VERSION.tar.bz2 -o wxWidgets-$WX_VERSION.tar.bz2
        tar jxf wxWidgets-$WX_VERSION.tar.bz2
        cd wxWidgets-$WX_VERSION
        ./configure --prefix=$HOME/wx-$WX_VERSION --enable-shared=no --enable-debug=no --with-gtk=2 --with-libjpeg=builtin --with-libpng=builtin --with-regex=builtin --with-libtiff=builtin --with-zlib=builtin --with-expat=builtin --without-libjbig --without-liblzma --without-gtkprint --with-libnotify=no --with-libmspack=no --with-gnomevfs=no --with-opengl=yes --with-sdl=no --with-cxx=11 
        make -j4
        make install
        sudo ln -s $HOME/wx-$WX_VERSION/bin/wx-config /usr/local/bin/wx-config-3
        wx-config-3 --cflags
        echo $HOME/wx-$WX_VERSION/bin >> $GITHUB_PATH


  build-mac:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-14-large, macos-latest]

    steps:
    - name: Setup cmake
      uses: jwlawson/actions-setup-cmake@v1.12
      with:
        cmake-version: '3.24.x'
    - name: Set relative paths
      run: | 
        LKDIR=$GITHUB_WORKSPACE/lk
        echo "LKDIR=$LKDIR" >> $GITHUB_ENV
        WEXDIR=$GITHUB_WORKSPACE/wex
        echo "WEXDIR=$WEXDIR" >> $GITHUB_ENV
        SSCDIR=$GITHUB_WORKSPACE/ssc
        echo "SSCDIR=$SSCDIR" >> $GITHUB_ENV
        RAPIDJSONDIR=$GITHUB_WORKSPACE/ssc
        echo "RAPIDJSONDIR=$RAPIDJSONDIR" >> $GITHUB_ENV
        SAMNTDIR=$GITHUB_WORKSPACE/sam
        echo "SAMNTDIR=$SAMNTDIR" >> $GITHUB_ENV

    - name: Set relative paths
      run: | 
        WXMSW3=$HOME/wx-$WX_VERSION
        echo "WXMSW3=$WXMSW3" >> $GITHUB_ENV
    - name: Get cached build of wxWidgets
      uses: actions/cache@v4
      id: cachedwx
      with:
        path: ${{env.WXMSW3}}/
        key: wxWidgets-${{ env.WX_VERSION }}-${{ matrix.os }}
    - name: Install wxWidgets
      if: steps.cachedwx.outputs.cache-hit != 'true'
      run: |
        curl -L https://github.com/wxWidgets/wxWidgets/releases/download/v$WX_VERSION/wxWidgets-$WX_VERSION.tar.bz2 -o wxWidgets-$WX_VERSION.tar.bz2
        tar jxf wxWidgets-$WX_VERSION.tar.bz2
        cd wxWidgets-$WX_VERSION
        ./configure --prefix=$HOME/wx-$WX_VERSION --enable-stl=yes --enable-shared=no --disable-debug_flag --with-cocoa --enable-universal_binary=x86_64,arm64 --enable-unicode --enable-webview --disable-mediactrl --with-cxx=11 --with-macosx-version-min=10.15  --with-libjpeg=builtin --with-libpng=builtin --with-regex=builtin --with-libtiff=builtin --with-zlib=builtin --with-expat=builtin
        make -j3
        make install
        sudo ln -s $HOME/wx-$WX_VERSION/bin/wx-config /usr/local/bin/wx-config-3
        wx-config-3 --cflags
        echo ${HOME}/wx-$WX_VERSION/bin >> $GITHUB_PATH
