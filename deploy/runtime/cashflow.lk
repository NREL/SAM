// setup cashflow tables////////////////////////////////////////////////////////
function state_federal_depreciation_tables()
{
	cfrow("% of Total\nDepreciable Basis,Gross Amount\nAllocated,IBI\nReduction,CBI\nReduction,Depreciable Basis\nPrior to ITC,ITC Qualifying\nCosts,% of ITC\nQualifying Costs,ITC\nAmount,ITC Basis\nDisallowance,ITC\nAmount,ITC Basis\nDisallowance,State ITC\nReduction,Federal ITC\nReduction,Depreciable Basis\nAfter ITC Reduction,First Year Bonus\nDepreciation,Depreciable Basis\nAfter Bonus Reduction",-2);

	cfrow("DEPRECIATION AND ITC: STATE", -1);
	cfrow("MACRS 5-yr,depr_stabas_percent_macrs_5,depr_alloc_macrs_5,depr_stabas_ibi_reduc_macrs_5,depr_stabas_cbi_reduc_macrs_5,depr_stabas_prior_itc_macrs_5,itc_sta_qual_macrs_5,depr_stabas_percent_qual_macrs_5,depr_stabas_percent_amount_macrs_5,itc_disallow_sta_percent_macrs_5,depr_stabas_fixed_amount_macrs_5,itc_disallow_sta_fixed_macrs_5,depr_stabas_itc_sta_reduction_macrs_5,depr_stabas_itc_fed_reduction_macrs_5,depr_stabas_after_itc_macrs_5,depr_stabas_first_year_bonus_macrs_5,depr_stabas_macrs_5");
	cfrow("MACRS 15-yr,depr_stabas_percent_macrs_15,depr_alloc_macrs_15,depr_stabas_ibi_reduc_macrs_15,depr_stabas_cbi_reduc_macrs_15,depr_stabas_prior_itc_macrs_15,itc_sta_qual_macrs_15,depr_stabas_percent_qual_macrs_15,depr_stabas_percent_amount_macrs_15,itc_disallow_sta_percent_macrs_15,depr_stabas_fixed_amount_macrs_15,itc_disallow_sta_fixed_macrs_15,depr_stabas_itc_sta_reduction_macrs_15,depr_stabas_itc_fed_reduction_macrs_15,depr_stabas_after_itc_macrs_15,depr_stabas_first_year_bonus_macrs_15,depr_stabas_macrs_15");
	cfrow("Straight Line 5-yr,depr_stabas_percent_sl_5,depr_alloc_sl_5,depr_stabas_ibi_reduc_sl_5,depr_stabas_cbi_reduc_sl_5,depr_stabas_prior_itc_sl_5,itc_sta_qual_sl_5,depr_stabas_percent_qual_sl_5,depr_stabas_percent_amount_sl_5,itc_disallow_sta_percent_sl_5,depr_stabas_fixed_amount_sl_5,itc_disallow_sta_fixed_sl_5,depr_stabas_itc_sta_reduction_sl_5,depr_stabas_itc_fed_reduction_sl_5,depr_stabas_after_itc_sl_5,depr_stabas_first_year_bonus_sl_5,depr_stabas_sl_5");
	cfrow("Straight Line 15-yr,depr_stabas_percent_sl_15,depr_alloc_sl_15,depr_stabas_ibi_reduc_sl_15,depr_stabas_cbi_reduc_sl_15,depr_stabas_prior_itc_sl_15,itc_sta_qual_sl_15,depr_stabas_percent_qual_sl_15,depr_stabas_percent_amount_sl_15,itc_disallow_sta_percent_sl_15,depr_stabas_fixed_amount_sl_15,itc_disallow_sta_fixed_sl_15,depr_stabas_itc_sta_reduction_sl_15,depr_stabas_itc_fed_reduction_sl_15,depr_stabas_after_itc_sl_15,depr_stabas_first_year_bonus_sl_15,depr_stabas_sl_15");
	cfrow("Straight Line 20-yr,depr_stabas_percent_sl_20,depr_alloc_sl_20,depr_stabas_ibi_reduc_sl_20,depr_stabas_cbi_reduc_sl_20,depr_stabas_prior_itc_sl_20,itc_sta_qual_sl_20,depr_stabas_percent_qual_sl_20,depr_stabas_percent_amount_sl_20,itc_disallow_sta_percent_sl_20,depr_stabas_fixed_amount_sl_20,itc_disallow_sta_fixed_sl_20,depr_stabas_itc_sta_reduction_sl_20,depr_stabas_itc_fed_reduction_sl_20,depr_stabas_after_itc_sl_20,depr_stabas_first_year_bonus_sl_20,depr_stabas_sl_20");
	cfrow("Straight Line 39-yr,depr_stabas_percent_sl_39,depr_alloc_sl_39,depr_stabas_ibi_reduc_sl_39,depr_stabas_cbi_reduc_sl_39,depr_stabas_prior_itc_sl_39,itc_sta_qual_sl_39,depr_stabas_percent_qual_sl_39,depr_stabas_percent_amount_sl_39,itc_disallow_sta_percent_sl_39,depr_stabas_fixed_amount_sl_39,itc_disallow_sta_fixed_sl_39,depr_stabas_itc_sta_reduction_sl_39,depr_stabas_itc_fed_reduction_sl_39,depr_stabas_after_itc_sl_39,depr_stabas_first_year_bonus_sl_39,depr_stabas_sl_39");
	cfrow("Custom,depr_stabas_percent_custom,depr_alloc_custom,depr_stabas_ibi_reduc_custom,depr_stabas_cbi_reduc_custom,depr_stabas_prior_itc_custom,itc_sta_qual_custom,depr_stabas_percent_qual_custom,depr_stabas_percent_amount_custom,itc_disallow_sta_percent_custom,depr_stabas_fixed_amount_custom,itc_disallow_sta_fixed_custom,depr_stabas_itc_sta_reduction_custom,depr_stabas_itc_fed_reduction_custom,depr_stabas_after_itc_custom,depr_stabas_first_year_bonus_custom,depr_stabas_custom");
	cfrow("Total,depr_stabas_percent_total,depr_alloc_total,depr_stabas_ibi_reduc_total,depr_stabas_cbi_reduc_total,depr_stabas_prior_itc_total,itc_sta_qual_total,depr_stabas_percent_qual_total,depr_stabas_percent_amount_total,itc_disallow_sta_percent_total,depr_stabas_fixed_amount_total,itc_disallow_sta_fixed_total,depr_stabas_itc_sta_reduction_total,depr_stabas_itc_fed_reduction_total,depr_stabas_after_itc_total,depr_stabas_first_year_bonus_total,depr_stabas_total");
	
	cfrow("DEPRECIATION AND ITC: FEDERAL", -1);
	cfrow("MACRS 5-yr,depr_fedbas_percent_macrs_5,depr_alloc_macrs_5,depr_fedbas_ibi_reduc_macrs_5,depr_fedbas_cbi_reduc_macrs_5,depr_fedbas_prior_itc_macrs_5,itc_fed_qual_macrs_5,depr_fedbas_percent_qual_macrs_5,depr_fedbas_percent_amount_macrs_5,itc_disallow_fed_percent_macrs_5,depr_fedbas_fixed_amount_macrs_5,itc_disallow_fed_fixed_macrs_5,depr_fedbas_itc_sta_reduction_macrs_5,depr_fedbas_itc_fed_reduction_macrs_5,depr_fedbas_after_itc_macrs_5,depr_fedbas_first_year_bonus_macrs_5,depr_fedbas_macrs_5");
	cfrow("MACRS 15-yr,depr_fedbas_percent_macrs_15,depr_alloc_macrs_15,depr_fedbas_ibi_reduc_macrs_15,depr_fedbas_cbi_reduc_macrs_15,depr_fedbas_prior_itc_macrs_15,itc_fed_qual_macrs_15,depr_fedbas_percent_qual_macrs_15,depr_fedbas_percent_amount_macrs_15,itc_disallow_fed_percent_macrs_15,depr_fedbas_fixed_amount_macrs_15,itc_disallow_fed_fixed_macrs_15,depr_fedbas_itc_sta_reduction_macrs_15,depr_fedbas_itc_fed_reduction_macrs_15,depr_fedbas_after_itc_macrs_15,depr_fedbas_first_year_bonus_macrs_15,depr_fedbas_macrs_15");
	cfrow("Straight Line 5-yr,depr_fedbas_percent_sl_5,depr_alloc_sl_5,depr_fedbas_ibi_reduc_sl_5,depr_fedbas_cbi_reduc_sl_5,depr_fedbas_prior_itc_sl_5,itc_fed_qual_sl_5,depr_fedbas_percent_qual_sl_5,depr_fedbas_percent_amount_sl_5,itc_disallow_fed_percent_sl_5,depr_fedbas_fixed_amount_sl_5,itc_disallow_fed_fixed_sl_5,depr_fedbas_itc_fed_reduction_sl_5,depr_fedbas_itc_sta_reduction_sl_5,depr_fedbas_after_itc_sl_5,depr_fedbas_first_year_bonus_sl_5,depr_fedbas_sl_5");
	cfrow("Straight Line 15-yr,depr_fedbas_percent_sl_15,depr_alloc_sl_15,depr_fedbas_ibi_reduc_sl_15,depr_fedbas_cbi_reduc_sl_15,depr_fedbas_prior_itc_sl_15,itc_fed_qual_sl_15,depr_fedbas_percent_qual_sl_15,depr_fedbas_percent_amount_sl_15,itc_disallow_fed_percent_sl_15,depr_fedbas_fixed_amount_sl_15,itc_disallow_fed_fixed_sl_15,depr_fedbas_itc_fed_reduction_sl_15,depr_fedbas_itc_sta_reduction_sl_15,depr_fedbas_after_itc_sl_15,depr_fedbas_first_year_bonus_sl_15,depr_fedbas_sl_15");
	cfrow("Straight Line 20-yr,depr_fedbas_percent_sl_20,depr_alloc_sl_20,depr_fedbas_ibi_reduc_sl_20,depr_fedbas_cbi_reduc_sl_20,depr_fedbas_prior_itc_sl_20,itc_fed_qual_sl_20,depr_fedbas_percent_qual_sl_20,depr_fedbas_percent_amount_sl_20,itc_disallow_fed_percent_sl_20,depr_fedbas_fixed_amount_sl_20,itc_disallow_fed_fixed_sl_20,depr_fedbas_itc_fed_reduction_sl_20,depr_fedbas_itc_sta_reduction_sl_20,depr_fedbas_after_itc_sl_20,depr_fedbas_first_year_bonus_sl_20,depr_fedbas_sl_20");
	cfrow("Straight Line 39-yr,depr_fedbas_percent_sl_39,depr_alloc_sl_39,depr_fedbas_ibi_reduc_sl_39,depr_fedbas_cbi_reduc_sl_39,depr_fedbas_prior_itc_sl_39,itc_fed_qual_sl_39,depr_fedbas_percent_qual_sl_39,depr_fedbas_percent_amount_sl_39,itc_disallow_fed_percent_sl_39,depr_fedbas_fixed_amount_sl_39,itc_disallow_fed_fixed_sl_39,depr_fedbas_itc_fed_reduction_sl_39,depr_fedbas_itc_sta_reduction_sl_39,depr_fedbas_after_itc_sl_39,depr_fedbas_first_year_bonus_sl_39,depr_fedbas_sl_39");
	cfrow("Custom,depr_fedbas_percent_custom,depr_alloc_custom,depr_fedbas_ibi_reduc_custom,depr_fedbas_cbi_reduc_custom,depr_fedbas_prior_itc_custom,itc_fed_qual_custom,depr_fedbas_percent_qual_custom,depr_fedbas_percent_amount_custom,itc_disallow_fed_percent_custom,depr_fedbas_fixed_amount_custom,itc_disallow_fed_fixed_custom,depr_fedbas_itc_fed_reduction_custom,depr_fedbas_itc_sta_reduction_custom,depr_fedbas_after_itc_custom,depr_fedbas_first_year_bonus_custom,depr_fedbas_custom");
	cfrow("Total,depr_fedbas_percent_total,depr_alloc_total,depr_fedbas_ibi_reduc_total,depr_fedbas_cbi_reduc_total,depr_fedbas_prior_itc_total,itc_fed_qual_total,depr_fedbas_percent_qual_total,depr_fedbas_percent_amount_total,itc_disallow_fed_percent_total,depr_fedbas_fixed_amount_total,itc_disallow_fed_fixed_total,depr_fedbas_itc_fed_reduction_total,depr_fedbas_itc_sta_reduction_total,depr_fedbas_after_itc_total,depr_fedbas_first_year_bonus_total,depr_fedbas_total");
}

function cf_cash_incentives()
{
	cfline( 'ibi_total_fed,ibi_total_sta,ibi_total_uti,ibi_total_oth,ibi_total', 0);
	cfline( '' ); // spacer 
	cfline( 'cbi_total_fed,cbi_total_sta,cbi_total_uti,cbi_total_oth,cbi_total', 0);
	cfline( '' ); // spacer 
	cfline( 'cf_pbi_total_fed,cf_pbi_total_sta,cf_pbi_total_uti,cf_pbi_total_oth,cf_pbi_total', 0);
	cfline( '' ); // spacer 
}

function cf_om_expenses() {

	cfline( 'cf_om_fixed_expense,cf_om_production_expense,cf_om_capacity_expense', 0);

    tech = technology();

    if (( tech == 'Flat Plate PV' || tech == 'Generic System' ) && value('en_batt') == 1 ) // PVWatts does not have battery replacements as of 2017.1.17
		cfline( 'cf_battery_replacement_cost', 0);

    fueltech = ( tech != 'Flat Plate PV' && 
                 tech != 'PVWatts' && 
                 tech != 'High-X Concentrating PV' && 
                 tech != 'Solar Water Heating' && 
                 tech != 'Wind Power' &&
                 tech != 'Biopower');
	if ( fueltech == true ) cfline('cf_om_fuel_expense', 0);
	
	if ( tech == 'Biopower' ) cfline( 'cf_om_opt_fuel_1_expense', 0);
	if ( tech == 'Biopower' ) cfline( 'cf_om_opt_fuel_2_expense', 0);
	
	if ( tech == "Geothermal" ) 
		if (value('system_use_recapitalization')==1) 
			cfline ('cf_recapitalization', 0); // do not use recapitalization until geothermal issues resolved.	

}

cashflow{ 'Residential' } = define()
{

	cfline( "PRODUCTION", -1);
	cfline( 'cf_energy_net', 0);
	cfline( '' ); // spacer

	cfline( "SAVINGS", -1);
	cfline( 'cf_energy_value', 0); 
	cfline( '' );

	cfline( "OPERATING EXPENSES", -1 ); // header	
    cf_om_expenses();
	
//	cfline( 'cf_property_tax_assessed_value');
	cfline( 'cf_property_tax_expense', 0);
	cfline( 'cf_insurance_expense', 0);
	cfline( 'cf_net_salvage_value', 0);
	cfline( 'cf_operating_expenses', 0);
	cfline( '' ); // spacer
	
	cfline( 'cf_deductible_expenses', 0);
	cfline( '' ); // spacer
	
	cfline( "PROJECT DEBT", -1 ); // header
	cfline( 'cf_debt_balance', 0);
	cfline( 'cf_debt_payment_interest', 0);
	cfline( 'cf_debt_payment_principal', 0);
	cfline( 'cf_debt_payment_total', 0);
	cfline( '' );	
	
	cfline( "DIRECT CASH INCENTIVES", -1 ); // header
	// incentives
	cf_cash_incentives();
	
	cfline( "STATE INCOME TAX", -1 ); // header
//	cfline( 'cf_sta_depr_sched', 0);
//	cfline( 'cf_sta_depreciation', 0);
//	cfline( 'cf_sta_incentive_income_less_deductions', 0);
	cfline( 'cf_sta_taxable_income_less_deductions', 0);
	cfline( 'cf_ptc_sta', 0);
	cfline( 'itc_total_sta', 0, 1, 1); // offset to year 1
	cfline( 'cf_sta_tax_savings', 0);
	cfline( '' ); // spacer
	
	cfline( "FEDERAL INCOME TAX", -1 ); // header
//	cfline( 'cf_fed_depr_sched' );
//	cfline( 'cf_fed_depreciation');
//	cfline( 'cf_fed_incentive_income_less_deductions');
	cfline( 'cf_fed_taxable_income_less_deductions', 0);	
	cfline( 'cf_ptc_fed', 0);
	cfline( 'itc_total_fed', 0, 1, 1); // offset to year 1
	cfline( 'cf_fed_tax_savings', 0);
	cfline( '' ); // spacer
	
	cfline( 'cf_after_tax_net_equity_cost_flow', 0);
	cfline( 'cf_after_tax_cash_flow', 0);
};

cashflow{ 'Commercial' } = define()
{
	cfline( "PRODUCTION", -1);
	cfline( 'cf_energy_net', 0);
	cfline( '' ); // spacer

	cfline( "SAVINGS", -1);
	cfline( 'cf_energy_value', 0); 
	cfline( '' );

	cfline( "OPERATING EXPENSES", -1 ); // header	
    cf_om_expenses();
	
//	cfline( 'cf_property_tax_assessed_value');
	cfline( 'cf_property_tax_expense', 0);
	cfline( 'cf_insurance_expense', 0);
	cfline( 'cf_net_salvage_value', 0);
	cfline( 'cf_operating_expenses', 0);
	cfline( '' ); // spacer
	
	cfline( 'cf_deductible_expenses', 0);
	cfline( '' ); // spacer
	
	cfline( "PROJECT DEBT", -1 ); // header
	cfline( 'cf_debt_balance', 0);
	cfline( 'cf_debt_payment_interest', 0);
	cfline( 'cf_debt_payment_principal', 0);
	cfline( 'cf_debt_payment_total', 0);
	cfline( '' );	
	
	cfline( "DIRECT CASH INCENTIVES", -1 ); // header
	// incentives
	cf_cash_incentives();
	
	cfline( "STATE INCOME TAX", -1 ); // header
	cfline( 'cf_sta_depr_sched');
	cfline( 'cf_sta_depreciation', 0);
	cfline( 'cf_sta_taxable_income_less_deductions', 0);
	cfline( 'cf_ptc_sta', 0);
	cfline( 'itc_total_sta', 0, 1, 1); // offset to year 1
	cfline( 'cf_sta_tax_savings', 0);
	cfline( '' ); // spacer
	
	cfline( "FEDERAL INCOME TAX", -1 ); // header
	cfline( 'cf_fed_depr_sched');
	cfline( 'cf_fed_depreciation', 0);
	cfline( 'cf_fed_taxable_income_less_deductions', 0);	
	cfline( 'cf_ptc_fed', 0);
	cfline( 'itc_total_fed', 0, 1, 1); // offset to year 1
	cfline( 'cf_fed_tax_savings', 0);
	cfline( '' ); // spacer
	
	cfline( 'cf_after_tax_net_equity_cost_flow', 0);
	cfline( 'cf_after_tax_cash_flow', 0);
};



cashflow{ 'Single Owner PPA Buy Rate' } = define() 
{

	cfline( "PRODUCTION (AC KWH)", -1);
	cfline( 'cf_energy_net', 0); // no decimal places with thousands separator

	cfline( '' ); // spacer with no shading
	cfline( "REVENUES", -1); // header with shading
	cfline( 'cf_ppa_price' , -2 ); // generic formatting to show all significant digits
	cfline( 'cf_energy_value', 0);
	cfline("plus PBI if available for debt service:", -1, 0); // label with no shading
	if (value('pbi_fed_for_ds')==1)cfline('cf_pbi_total_fed',0);
	if (value('pbi_sta_for_ds')==1)cfline('cf_pbi_total_sta',0);
	if (value('pbi_uti_for_ds')==1)cfline( 'cf_pbi_total_uti',0);
	if (value('pbi_oth_for_ds')==1)cfline('cf_pbi_total_oth',0);
	cfline( 'cf_net_salvage_value', 0);
	cfline( 'cf_total_revenue', 0);

	cfline( '' );
	cfline( 'cf_property_tax_assessed_value', 0);

	cfline( '' );
	cfline( "OPERATING EXPENSES", -1 );
	cf_om_expenses();
	cfline( 'cf_utility_bill', 0);
	cfline( 'cf_property_tax_expense', 0);
	cfline( 'cf_insurance_expense', 0);
	cfline( 'cf_operating_expenses', 0);
	
	cfline( '' );
	cfline( 'cf_ebitda', 0);

	cfline( '' );
	cfline( "CASH FLOWS FROM OPERATING ACTIVITIES", -1 );
	cfline( 'cf_ebitda', 0);
	cfline( 'cf_reserve_interest', 0);
	cfline("plus PBI if not available for debt service:", -1, 0);
	if (value('pbi_fed_for_ds')==0)cfline('cf_pbi_total_fed',0);
	if (value('pbi_sta_for_ds')==0)cfline('cf_pbi_total_sta',0);
	if (value('pbi_uti_for_ds')==0)cfline('cf_pbi_total_uti',0);
	if (value('pbi_oth_for_ds')==0)cfline('cf_pbi_total_oth',0);
	cfline("minus:", -1, 0);
	cfline('cf_debt_payment_interest', 0);
	cfline("equals:", -1, 0);
	cfline('cf_project_operating_activities', 0);
	cfline( '' );

	cfline( "CASH FLOWS FROM INVESTING ACTIVITIES", -1);
	cfline('cost_prefinancing',0,-1,0);
	cfline('cost_debt_closing',0,-1,0);
	cfline('cost_debt_upfront',0,-1,0);
	cfline('cost_other_financing',0,-1,0);
	cfline('construction_financing_cost',0,-1,0);
	cfline( 'ibi_total', 0);
	cfline( 'cbi_total', 0);
	cfline("equals:", -1, 0);
	cfline('purchase_of_property', 0);
	cfline("plus:", -1, 0);
	cfline('cf_project_dsra', 0);
	cfline('cf_project_wcra', 0);
	cfline('cf_project_receivablesra', 0);
	cfline('cf_project_me1ra', 0);
	cfline('cf_project_me2ra', 0);
	cfline('cf_project_me3ra', 0);
	cfline('cf_project_me1cs', 0);
	cfline('cf_project_me2cs', 0);
	cfline('cf_project_me3cs', 0);
	cfline("equals:", -1, 0);	
	cfline('cf_project_investing_activities', 0);
	
	cfline( '' );
	cfline("CASH FLOWS FROM FINANCING ACTIVITIES", -1);
	cfline( 'ibi_total', 0);
	cfline( 'cbi_total', 0);
	cfline( 'size_of_debt', 0);
	cfline( 'issuance_of_equity',0);
	cfline('cf_debt_payment_principal', 0);
	cfline("equals:", -1, 0);	
	cfline('cf_project_financing_activities', 0);
	
//	cfline( '' );
//	cfline('cf_pretax_cashflow', 0);

	cfline( '' );
	cfline( "PRE-TAX PROJECT RETURNS", -1);
	cfline( 'issuance_of_equity',0,-1,0);
	cfline('cf_project_operating_activities', 0);
	cfline('cf_project_investing_activities', 0);	
	cfline('cf_project_financing_activities', 0);
	cfline("equals:", -1, 0);
	cfline('cf_project_return_pretax', 0);
//	cfline( '' );
//	cfline('cf_project_return_pretax_irr', 2);
//	cfline('cf_project_return_pretax_npv', 0);

	cfline( '' );
	cfline("AFTER-TAX PROJECT RETURNS", -1);
	cfline('cf_project_return_pretax', 0);
	cfline('itc_total_fed', 0, 1, 1 ); // offset column to year 1
	cfline('cf_ptc_fed', 0);
	cfline('cf_fedtax', 0);
	cfline('itc_total_sta', 0);
	cfline('cf_ptc_sta', 0);
	cfline('cf_statax', 0);
	cfline('cf_project_return_aftertax', 0);

	cfline( '' );
	cfline("RETURN ON EQUITY", -1);
	cfline('cf_return_on_equity_input', 2,100);
	cfline('cf_return_on_equity_dollars', 0);
	cfline('cf_return_on_equity', 2);

	cfline( '' );
	cfline("AFTER-TAX IRR AND NPV", -1);
	cfline('cf_project_return_aftertax_irr', 2);
	cfline('cf_project_return_aftertax_npv', 0);
	cfline( '' );
	cfline("AFTER-TAX EVELIZED COE AND PPA PRICE", -1);
	cfline('cf_annual_costs', 0);
	cfline('cf_energy_value', 0);
	cfline('cf_energy_net', 0); 
	cfline( '' );
	cfline('npv_annual_costs',0 );
	cfline('npv_energy_nom', 0);
	cfline('lcoe_nom',2);
	cfline( '' );
	cfline('npv_ppa_revenue', 0);
	cfline('npv_energy_nom', 0);
	cfline('lppa_nom',2);

	cfline( '' );
	cfline("STATE INCOME TAXES", -1);
	cfline('cf_ebitda', 0);
	cfline('cf_reserve_interest', 0);
	cfline('ibi_statax_total', 0, 1, 1);
	cfline('cbi_statax_total', 0, 1, 1);
	cfline('cf_pbi_statax_total', 0);
	cfline("minus:", -1, 0);
	cfline('cf_debt_payment_interest', 0);
	cfline('cf_stadepr_total', 0);
	cfline("equals:", -1, 0);
	cfline('cf_statax_income_with_incentives', 0);
	cfline( '' );
	cfline('cf_state_tax_frac');
	cfline('cf_statax', 0);

	cfline( '' );
	cfline("FEDERAL INCOME TAXES", -1);
	cfline('cf_ebitda', 0);
	cfline('cf_reserve_interest', 0);
	cfline('cf_statax', 0);
	cfline('itc_total_sta', 0);
	cfline('cf_ptc_sta', 0);
	cfline('ibi_fedtax_total', 0, 1, 1);
	cfline('cbi_fedtax_total', 0, 1, 1);
	cfline('cf_pbi_fedtax_total', 0);
	cfline("minus:", -1, 0);
	cfline('cf_debt_payment_interest', 0);
	cfline('cf_feddepr_total', 0);
	cfline("equals:", -1, 0);
	cfline('cf_fedtax_income_with_incentives', 0);
	cfline( '' );
	cfline('cf_federal_tax_frac');
	cfline('cf_fedtax', 0);

	cfline( '' );
	cfline( "INCENTIVES", -1);
	cf_cash_incentives();
	cfline( 'cf_ptc_fed,cf_ptc_sta' );
	cfline( '' );
	cfline( 'itc_total_fed,itc_total_sta', 0, 1, 1); // offset to year 1
	cfline( '' );

	cfline( "DEBT REPAYMENT", -1);
	cfline('cf_debt_payment_total', 0);
	cfline('cf_debt_payment_interest', 0);
	cfline('cf_debt_payment_principal', 0);
	cfline('cf_debt_balance', 0);
	
	if ( value('debt_option') == 0 ) {
	  cfline( '' );
	  cfline( "DSCR (DEBT FRACTION)", -1);
	  cfline('cf_ebitda', 0);
	  cfline("minus:", -1, 0);
	  cfline('cf_funding_equip1', 0);
	  cfline('cf_funding_equip2', 0);
	  cfline('cf_funding_equip3', 0);
	  cfline('cf_funding_receivables',0);
	  cfline("equals:", -1, 0);
  	  cfline('cf_cash_for_ds', 0);
      cfline('cf_debt_payment_total', 0);
      cfline('cf_pretax_dscr', 2);
	}

    if ( value('debt_option') == 1 ) {
	  cfline( '' );
	  cfline( "DEBT SIZING (SCULPTED DEBT PAYMENTS)", -1);
	  cfline('cf_ebitda', 0);
	  cfline("minus:", -1, 0);
	  cfline('cf_funding_equip1', 0);
	  cfline('cf_funding_equip2', 0);
	  cfline('cf_funding_equip3', 0);
	  cfline('cf_funding_receivables',0);
	  cfline("equals:", -1, 0);
	  cfline('cf_cash_for_ds', 0);
	  cfline('cf_pv_interest_factor', 2);
	  cfline('cf_pv_cash_for_ds', 0);
      cfline('cf_pretax_dscr', 2);
	  cfline('cf_debt_size', 0);
    }
    
	cfline( '' );
	cfline("RESERVES", -1);
	cfline( '' );
	cfline('cf_funding_debtservice', 0);
	cfline('cf_disbursement_debtservice', 0);
	cfline('cf_reserve_debtservice', 0);
	cfline( '' );
	cfline('cf_funding_om', 0);
	cfline('cf_disbursement_om', 0);
	cfline('cf_reserve_om', 0);
	cfline( '' );
	cfline('cf_funding_receivables', 0);
	cfline('cf_disbursement_receivables', 0);
	cfline('cf_reserve_receivables', 0);
	cfline( '' );
	cfline('cf_funding_equip1', 0);
	cfline('cf_disbursement_equip1', 0);
	cfline('cf_reserve_equip1', 0);
	cfline( '' );
	cfline('cf_funding_equip2', 0);
	cfline('cf_disbursement_equip2', 0);
	cfline('cf_reserve_equip2', 0);
	cfline( '' );
	cfline('cf_funding_equip3', 0);
	cfline('cf_disbursement_equip3', 0);
	cfline('cf_reserve_equip3', 0);
	cfline( '' );
	cfline( '' );
	cfline('cf_reserve_total', 0);
	cfline('reserves_interest');
	cfline( 'cf_reserve_interest', 0);


	state_federal_depreciation_tables();

};


cashflow{ 'Single Owner' } = define() 
{

	cfline( "PRODUCTION (AC KWH)", -1);
	cfline( 'cf_energy_net', 0); // no decimal places with thousands separator

	cfline( '' ); // spacer with no shading
	cfline( "REVENUES", -1); // header with shading
	cfline( 'cf_ppa_price' , -2 ); // generic formatting to show all significant digits
	cfline( 'cf_energy_value', 0);
	cfline("plus PBI if available for debt service:", -1, 0); // label with no shading
	if (value('pbi_fed_for_ds')==1)cfline('cf_pbi_total_fed',0);
	if (value('pbi_sta_for_ds')==1)cfline('cf_pbi_total_sta',0);
	if (value('pbi_uti_for_ds')==1)cfline( 'cf_pbi_total_uti',0);
	if (value('pbi_oth_for_ds')==1)cfline('cf_pbi_total_oth',0);
	cfline( 'cf_net_salvage_value', 0);
	cfline( 'cf_total_revenue', 0);

	cfline( '' );
	cfline( 'cf_property_tax_assessed_value', 0);

	cfline( '' );
	cfline( "OPERATING EXPENSES", -1 );
	cf_om_expenses();
	cfline( 'cf_property_tax_expense', 0);
	cfline( 'cf_insurance_expense', 0);
	cfline( 'cf_operating_expenses', 0);
	
	cfline( '' );
	cfline( 'cf_ebitda', 0);

	cfline( '' );
	cfline( "CASH FLOWS FROM OPERATING ACTIVITIES", -1 );
	cfline( 'cf_ebitda', 0);
	cfline( 'cf_reserve_interest', 0);
	cfline("plus PBI if not available for debt service:", -1, 0);
	if (value('pbi_fed_for_ds')==0)cfline('cf_pbi_total_fed',0);
	if (value('pbi_sta_for_ds')==0)cfline('cf_pbi_total_sta',0);
	if (value('pbi_uti_for_ds')==0)cfline('cf_pbi_total_uti',0);
	if (value('pbi_oth_for_ds')==0)cfline('cf_pbi_total_oth',0);
	cfline("minus:", -1, 0);
	cfline('cf_debt_payment_interest', 0);
	cfline("equals:", -1, 0);
	cfline('cf_project_operating_activities', 0);
	cfline( '' );

	cfline( "CASH FLOWS FROM INVESTING ACTIVITIES", -1);
	cfline('cost_prefinancing',0,-1,0);
	cfline('cost_debt_closing',0,-1,0);
	cfline('cost_debt_upfront',0,-1,0);
	cfline('cost_other_financing',0,-1,0);
	cfline('construction_financing_cost',0,-1,0);
	cfline( 'ibi_total', 0);
	cfline( 'cbi_total', 0);
	cfline("equals:", -1, 0);
	cfline('purchase_of_property', 0);
	cfline("plus:", -1, 0);
	cfline('cf_project_dsra', 0);
	cfline('cf_project_wcra', 0);
	cfline('cf_project_receivablesra', 0);
	cfline('cf_project_me1ra', 0);
	cfline('cf_project_me2ra', 0);
	cfline('cf_project_me3ra', 0);
	cfline('cf_project_me1cs', 0);
	cfline('cf_project_me2cs', 0);
	cfline('cf_project_me3cs', 0);
	cfline("equals:", -1, 0);	
	cfline('cf_project_investing_activities', 0);
	
	cfline( '' );
	cfline("CASH FLOWS FROM FINANCING ACTIVITIES", -1);
	cfline( 'ibi_total', 0);
	cfline( 'cbi_total', 0);
	cfline( 'size_of_debt', 0);
	cfline( 'issuance_of_equity',0);
	cfline('cf_debt_payment_principal', 0);
	cfline("equals:", -1, 0);	
	cfline('cf_project_financing_activities', 0);
	
//	cfline( '' );
//	cfline('cf_pretax_cashflow', 0);

	cfline( '' );
	cfline( "PRE-TAX PROJECT RETURNS", -1);
	cfline( 'issuance_of_equity',0,-1,0);
	cfline('cf_project_operating_activities', 0);
	cfline('cf_project_investing_activities', 0);	
	cfline('cf_project_financing_activities', 0);
	cfline("equals:", -1, 0);
	cfline('cf_project_return_pretax', 0);
//	cfline( '' );
//	cfline('cf_project_return_pretax_irr', 2);
//	cfline('cf_project_return_pretax_npv', 0);

	cfline( '' );
	cfline("AFTER-TAX PROJECT RETURNS", -1);
	cfline('cf_project_return_pretax', 0);
	cfline('itc_total_fed', 0, 1, 1 ); // offset column to year 1
	cfline('cf_ptc_fed', 0);
	cfline('cf_fedtax', 0);
	cfline('itc_total_sta', 0);
	cfline('cf_ptc_sta', 0);
	cfline('cf_statax', 0);
	cfline('cf_project_return_aftertax', 0);

	cfline( '' );
	cfline("RETURN ON EQUITY", -1);
	cfline('cf_return_on_equity_input', 2,100);
	cfline('cf_return_on_equity_dollars', 0);
	cfline('cf_return_on_equity', 2);

	cfline( '' );
	cfline("AFTER-TAX IRR AND NPV", -1);
	cfline('cf_project_return_aftertax_irr', 2);
	cfline('cf_project_return_aftertax_npv', 0);
	cfline( '' );
	cfline("AFTER-TAX EVELIZED COE AND PPA PRICE", -1);
	cfline('cf_annual_costs', 0);
	cfline('cf_energy_value', 0);
	cfline('cf_energy_net', 0); 
	cfline( '' );
	cfline('npv_annual_costs',0 );
	cfline('npv_energy_nom', 0);
	cfline('lcoe_nom',2);
	cfline( '' );
	cfline('npv_ppa_revenue', 0);
	cfline('npv_energy_nom', 0);
	cfline('lppa_nom',2);

	cfline( '' );
	cfline("STATE INCOME TAXES", -1);
	cfline('cf_ebitda', 0);
	cfline('cf_reserve_interest', 0);
	cfline('ibi_statax_total', 0, 1, 1);
	cfline('cbi_statax_total', 0, 1, 1);
	cfline('cf_pbi_statax_total', 0);
	cfline("minus:", -1, 0);
	cfline('cf_debt_payment_interest', 0);
	cfline('cf_stadepr_total', 0);
	cfline("equals:", -1, 0);
	cfline('cf_statax_income_with_incentives', 0);
	cfline( '' );
	cfline('cf_state_tax_frac');
	cfline('cf_statax', 0);

	cfline( '' );
	cfline("FEDERAL INCOME TAXES", -1);
	cfline('cf_ebitda', 0);
	cfline('cf_reserve_interest', 0);
	cfline('cf_statax', 0);
	cfline('itc_total_sta', 0);
	cfline('cf_ptc_sta', 0);
	cfline('ibi_fedtax_total', 0, 1, 1);
	cfline('cbi_fedtax_total', 0, 1, 1);
	cfline('cf_pbi_fedtax_total', 0);
	cfline("minus:", -1, 0);
	cfline('cf_debt_payment_interest', 0);
	cfline('cf_feddepr_total', 0);
	cfline("equals:", -1, 0);
	cfline('cf_fedtax_income_with_incentives', 0);
	cfline( '' );
	cfline('cf_federal_tax_frac');
	cfline('cf_fedtax', 0);

	cfline( '' );
	cfline( "INCENTIVES", -1);
	cf_cash_incentives();
	cfline( 'cf_ptc_fed,cf_ptc_sta' );
	cfline( '' );
	cfline( 'itc_total_fed,itc_total_sta', 0, 1, 1); // offset to year 1
	cfline( '' );

	cfline( "DEBT REPAYMENT", -1);
	cfline('cf_debt_payment_total', 0);
	cfline('cf_debt_payment_interest', 0);
	cfline('cf_debt_payment_principal', 0);
	cfline('cf_debt_balance', 0);
	
	if ( value('debt_option') == 0 ) {
	  cfline( '' );
	  cfline( "DSCR (DEBT FRACTION)", -1);
	  cfline('cf_ebitda', 0);
	  cfline("minus:", -1, 0);
	  cfline('cf_funding_equip1', 0);
	  cfline('cf_funding_equip2', 0);
	  cfline('cf_funding_equip3', 0);
	  cfline('cf_funding_receivables',0);
	  cfline("equals:", -1, 0);
  	  cfline('cf_cash_for_ds', 0);
      cfline('cf_debt_payment_total', 0);
      cfline('cf_pretax_dscr', 2);
	}

    if ( value('debt_option') == 1 ) {
	  cfline( '' );
	  cfline( "DEBT SIZING (SCULPTED DEBT PAYMENTS)", -1);
	  cfline('cf_ebitda', 0);
	  cfline("minus:", -1, 0);
	  cfline('cf_funding_equip1', 0);
	  cfline('cf_funding_equip2', 0);
	  cfline('cf_funding_equip3', 0);
	  cfline('cf_funding_receivables',0);
	  cfline("equals:", -1, 0);
	  cfline('cf_cash_for_ds', 0);
	  cfline('cf_pv_interest_factor', 2);
	  cfline('cf_pv_cash_for_ds', 0);
      cfline('cf_pretax_dscr', 2);
	  cfline('cf_debt_size', 0);
    }
    
	cfline( '' );
	cfline("RESERVES", -1);
	cfline( '' );
	cfline('cf_funding_debtservice', 0);
	cfline('cf_disbursement_debtservice', 0);
	cfline('cf_reserve_debtservice', 0);
	cfline( '' );
	cfline('cf_funding_om', 0);
	cfline('cf_disbursement_om', 0);
	cfline('cf_reserve_om', 0);
	cfline( '' );
	cfline('cf_funding_receivables', 0);
	cfline('cf_disbursement_receivables', 0);
	cfline('cf_reserve_receivables', 0);
	cfline( '' );
	cfline('cf_funding_equip1', 0);
	cfline('cf_disbursement_equip1', 0);
	cfline('cf_reserve_equip1', 0);
	cfline( '' );
	cfline('cf_funding_equip2', 0);
	cfline('cf_disbursement_equip2', 0);
	cfline('cf_reserve_equip2', 0);
	cfline( '' );
	cfline('cf_funding_equip3', 0);
	cfline('cf_disbursement_equip3', 0);
	cfline('cf_reserve_equip3', 0);
	cfline( '' );
	cfline( '' );
	cfline('cf_reserve_total', 0);
	cfline('reserves_interest');
	cfline( 'cf_reserve_interest', 0);


	state_federal_depreciation_tables();

};

/*
cashflow{ 'All Equity Partnership Flip' } = define()
{
	cfline('Partial Income Statement: Project', -1);

    	tech = technology();

    	fueltech = ( tech != 'Flat Plate PV' && 
                 tech != 'PVWatts' && 
                 tech != 'High-X Concentrating PV' && 
                 tech != 'Solar Water Heating' && 
                 tech != 'Wind Power');
    
	cfline( 'cf_energy_net', 0); // use one digit
	cfline( 'cf_ppa_price', 2);
	cfline( 'cf_energy_value', 0);
	cfline( 'cf_net_salvage_value', 0);

	cfline( 'cf_total_revenue', 0);

	cfline( '' ); // spacer

	cfline( 'cf_property_tax_assessed_value', 0);

	cfline( '' ); // spacer

	cfline( "Expenses", -1 ); // header	
	if (value('system_use_recapitalization'))cfline('cf_recapitalization', 0);
	cfline( 'cf_om_fixed_expense,cf_om_production_expense,cf_om_capacity_expense', 0);
	if ( fueltech == true )cfline('cf_om_fuel_expense', 0);
	if ( fueltech == true )cfline('cf_om_opt_fuel_1_expense', 0);
	if ( fueltech == true )cfline('cf_om_opt_fuel_2_expense', 0);
	cfline( 'cf_property_tax_expense', 0);
	cfline( 'cf_insurance_expense', 0);
	cfline( 'cf_operating_expenses', 0);
	cfline( '' ); // spacer
	
	cfline( 'cf_ebitda', 0);
	cfline( '' ); // spacer

	cfline('Cash Flow: Project', -1);
	cfline('Cash Flows from Operating Activities', -1, 0);
	cfline( 'cf_ebitda', 0);
	cfline( 'cf_reserve_interest', 0);
	cfline('cf_project_operating_activities', 0);
	cfline( '' ); // spacer
	cfline( "Cash Flows from Investing Activities", -1, 0);
	cfline( 'purchase_of_property', 0);
	cfline( '' ); // spacer
	cfline( 'cf_project_wcra', 0);
	cfline('cf_project_me1ra', 0);
	cfline('cf_project_me2ra', 0);
	cfline('cf_project_me3ra', 0);
	cfline('cf_project_ra', 0);
	cfline( '' ); // spacer
	cfline('cf_project_me1cs', 0);
	cfline('cf_project_me2cs', 0);
	cfline('cf_project_me3cs', 0);
	cfline('cf_project_mecs', 0);
	cfline( '' ); // spacer
	cfline('cf_project_investing_activities', 0);
	cfline( '' ); // spacer
	cfline( "Project Cash Flows From Financing Activities", -1);
	cfline( 'ibi_total', 0);
	cfline( 'cbi_total', 0);
	cfline( 'issuance_of_equity', 0);
	cfline('cf_project_financing_activities', 0);
	cfline( '' ); // spacer
	cfline('cf_pretax_cashflow', 0);
	cfline( '' ); // spacer
	cfline( 'Total Project Returns', -1);
	cfline( 'Pre-Tax', -1, 0);
	cfline('cf_project_return_pretax', 0);
	cfline('cf_project_return_pretax_irr', 2);
	cfline('cf_project_return_pretax_npv', 0);
	cfline( '' ); // spacer
	cfline( 'After-Tax', -1, 0);
	cfline('cf_project_return_aftertax_cash', 0);
	cfline('cf_project_return_aftertax', 0);
	cfline('cf_project_return_aftertax_irr', 2);
	cfline('cf_project_return_aftertax_npv', 0);
	cfline( '' ); // spacer

// LCOE
	cfline("LEVELIZED COE AND PPA PRICE", -1);
	cfline('cf_annual_costs', 0);
	cfline('cf_energy_value', 0);
	cfline('cf_energy_net', 0); 
	cfline( '' );
	cfline('npv_annual_costs',0 );
	cfline('npv_energy_nom', 0);
	cfline('lcoe_nom',2);
	cfline( '' );
	cfline('npv_ppa_revenue', 0);
	cfline('npv_energy_nom', 0);
	cfline('lppa_nom',2);
	cfline( '' );


	cfline('Partners Returns', -1);
	cfline( 'Tax Invester Pre-tax Returns', -1);
	cfline('cf_tax_investor_pretax', 0);//"Total tax investor pre-tax returns");
	cfline('cf_tax_investor_pretax_irr', 2);//"Tax investor cumulative IRR");
	cfline('cf_tax_investor_pretax_npv', 0);//"Tax investor cumulative NPV");
	cfline( '' ); // spacer
	cfline( 'Tax Invester After-tax Returns', -1);
	cfline('cf_tax_investor_aftertax_cash', 0);//"Tax investor cash (total pre-tax returns)");
	cfline('cf_tax_investor_aftertax_itc', 0);//"ITC");
	cfline('cf_tax_investor_aftertax_ptc', 0);//"PTC");
	cfline('cf_tax_investor_aftertax_tax', 0);//Tax investor share of project tax");
	cfline('cf_tax_investor_aftertax', 0);//Total tax investor after-tax returns");
	cfline('cf_tax_investor_aftertax_irr', 2);//Tax investor cumulative IRR");
	cfline('cf_tax_investor_aftertax_npv', 0);//Tax investor cumulative NPV");
	cfline('cf_tax_investor_aftertax_max_irr', 2);//Tax investor maximum IRR");
	cfline( '' ); // spacer


	cfline('Developer Capital Recovery', -1);
	cfline('cf_sponsor_capital_recovery_cash', 0);
	cfline('cf_sponsor_capital_recovery_balance', 0);
	cfline( '' ); // spacer
	cfline('Developer Pre-tax Returns', -1);
	cfline('sponsor_pretax_equity', 0);//"Developer Pre-tax Returns");
	cfline('sponsor_pretax_development', 0);//"Pre-tax development fee");
	cfline('cf_sponsor_pretax', 0);//"Total developer pre-tax returns");
	cfline('cf_sponsor_pretax_irr', 2);//"Developer pre-tax cumulative IRR");
	cfline('cf_sponsor_pretax_npv', 0);//"Developer pre-tax cumulative NPV");
	cfline('sponsor_pretax_irr', 2);//"Developer pre-tax IRR");
	cfline('sponsor_pretax_npv', 0);//"Developer pre-tax NPV");
	cfline( '' ); // spacer
	cfline( 'Developer After-tax Returns', -1);
	cfline('sponsor_aftertax_equity', 0);//"Equity Investment");
	cfline('sponsor_aftertax_development', 0);//"Development Fee");
	cfline('cf_sponsor_aftertax_cash', 0);//"Cash");
	cfline('cf_sponsor_aftertax_itc', 0);//"ITC");
	cfline('cf_sponsor_aftertax_ptc', 0);//"PTC");
	cfline('cf_sponsor_aftertax_tax', 0);//"Developer share of project tax");
	cfline('cf_sponsor_aftertax', 0);//"Total developer after-tax returns");
	cfline('cf_sponsor_aftertax_irr', 2);//"Developer after-tax cumulative IRR");
	cfline('cf_sponsor_aftertax_npv', 0);//"Developer after-tax cumulative NPV");
	cfline('sponsor_aftertax_irr', 2);//"Developer after-tax IRR");
	cfline('sponsor_aftertax_npv', 0);//"Developer after-tax NPV");
	cfline( '' ); // spacer

	// incentives
	cfline( 'Incentives', -1);
	cf_cash_incentives();
	cfline( 'cf_ptc_fed,cf_ptc_sta' );
	cfline( '' );
	cfline( 'itc_total_fed,itc_total_sta', 0, 1, 1); // offset to year 1
	cfline( '' );

	// reserve accounts
	cfline( 'Reserve Accounts', -1);
//	cfline('cf_reserve_debtservice', 0);
	cfline('cf_reserve_om', 0);
	cfline('cf_reserve_equip1', 0);
	cfline('cf_reserve_equip2', 0);
	cfline('cf_reserve_equip3', 0);
	cfline( '' ); // spacer
	cfline( '' ); // spacer

	// state and federal depreciation/itc tables
	state_federal_depreciation_tables();
};	*/

cashflow{ 'Leveraged Partnership Flip' } = define()
{

	cfline( "PRODUCTION (AC KWH)",-1);
	cfline( 'cf_energy_net', 0); // no decimal places with thousands separator

	cfline( '' ); // spacer with no shading

	cfline("REVENUES", -1);
	cfline( 'cf_ppa_price', -2 );
	cfline( 'cf_energy_value', 0);
	cfline("plus PBI if available for debt service:", -1, 0); // label with no shading
	if (value('pbi_fed_for_ds')==1)cfline( 'cf_pbi_total_fed', 0);
	if (value('pbi_sta_for_ds')==1)cfline( 'cf_pbi_total_sta', 0);
	if (value('pbi_uti_for_ds')==1)cfline( 'cf_pbi_total_uti', 0);
	if (value('pbi_oth_for_ds')==1)cfline( 'cf_pbi_total_oth', 0);
	cfline( 'cf_net_salvage_value', 0);
	cfline( 'cf_total_revenue', 0);

	cfline( '' ); // spacer
	cfline( 'cf_property_tax_assessed_value', 0);

	cfline( '' ); // spacer
	cfline("PROJECT OPERATING EXPENSES", -1);
	cf_om_expenses();
	cfline( 'cf_property_tax_expense', 0);
	cfline( 'cf_insurance_expense', 0);
	cfline( 'cf_operating_expenses', 0);
	cfline( '' ); // spacer
	
	cfline( 'cf_ebitda', 0);
	cfline( '' ); // spacer

	cfline("**PROJECT CASH FLOWS**", -1);
	cfline( '' ); // spacer
	
	cfline("PROJECT OPERATING ACTIVITIES", -1, 0);
	cfline( 'cf_ebitda', 0);
	cfline( 'cf_reserve_interest', 0);
	cfline("plus PBI if not available for debt service:", -1, 0);
	if (value('pbi_fed_for_ds')==0)cfline( 'cf_pbi_total_fed', 0);
	if (value('pbi_sta_for_ds')==0)cfline( 'cf_pbi_total_sta', 0);
	if (value('pbi_uti_for_ds')==0)cfline( 'cf_pbi_total_uti', 0);
	if (value('pbi_oth_for_ds')==0)cfline( 'cf_pbi_total_oth', 0);
	cfline("minus:", -1, 0);
	cfline('cf_debt_payment_interest', 0);
	cfline("equals:", -1, 0);
	cfline('cf_project_operating_activities', 0);
	cfline( '' ); // spacer

	cfline( "PROJECT INVESTING ACTIVITIES", -1);
	cfline('cost_prefinancing',0,-1,0);
	cfline('cost_equity_closing',0,-1,0);
	cfline('cost_debt_closing',0,-1,0);
	cfline('cost_debt_upfront',0,-1,0);
	cfline('sponsor_aftertax_development', 0,-1,0);//"Development Fee");
	cfline('cost_other_financing',0,-1,0);
	cfline('construction_financing_cost',0,-1,0);
	cfline( 'ibi_total', 0);
	cfline( 'cbi_total', 0);
	cfline("equals:", -1, 0);
	cfline( 'purchase_of_property', 0);
	cfline("plus:", -1, 0);
	cfline('cf_project_dsra', 0);
	cfline( 'cf_project_wcra', 0);
	cfline('cf_project_receivablesra', 0);
	cfline('cf_project_me1ra', 0);
	cfline('cf_project_me2ra', 0);
	cfline('cf_project_me3ra', 0);
	cfline('cf_project_me1cs', 0);
	cfline('cf_project_me2cs', 0);
	cfline('cf_project_me3cs', 0);
	cfline("equals:", -1, 0);	
	cfline('cf_project_investing_activities', 0);
	cfline( '' ); // spacer

	cfline( "PROJECT FINANCING ACTIVITIES", -1);
	cfline( 'issuance_of_equity',0);
	cfline( 'size_of_debt', 0);
	cfline( 'ibi_total', 0);
	cfline( 'cbi_total', 0);
	cfline("minus:", -1, 0);	
	cfline('cf_debt_payment_principal', 0);
	cfline("equals:", -1, 0);
	cfline('cf_project_financing_activities', 0);
	cfline( '' ); // spacer

	cfline( "PROJECT PRE-TAX RETURNS", -1);
	cfline('cf_project_operating_activities', 0);
	cfline('cf_project_investing_activities', 0);	
	cfline('cf_project_financing_activities', 0);
	cfline("equals:", -1, 0);
	cfline('cf_pretax_cashflow', 0);
	cfline("plus:", -1, 0);
	cfline( 'issuance_of_equity',0,-1,0);
	cfline("equals:", -1, 0);
	cfline('cf_project_return_pretax', 0);
	cfline( '' ); // spacer

	cfline( "PROJECT PRE-TAX IRR AND NPV", -1);
	cfline('cf_project_return_pretax_irr', 2);
	cfline('cf_project_return_pretax_npv', 0);
	cfline( '' ); // spacer

	cfline( "PROJECT AFTER-TAX RETURNS", -1, 0);
	cfline('cf_project_return_pretax', 0);
	cfline('itc_total_fed', 0, 1, 1 ); // offset column to year 1
	cfline('cf_ptc_fed', 0);
	cfline('cf_fedtax_income_with_incentives',0);
	cfline('cf_federal_tax_frac',0);
	cfline('cf_fedtax', 0);
	cfline('itc_total_sta', 0);
	cfline('cf_ptc_sta', 0);
	cfline('cf_state_tax_frac',0);
	cfline('cf_statax_income_with_incentives',0);
	cfline('cf_statax', 0);
//	cfline('cf_project_return_aftertax_cash', 0);
	cfline('cf_project_return_aftertax', 0);
	cfline( '' );
	
	cfline( "PROJECT AFTER-TAX IRR AND NPV", -1);
	cfline('cf_project_return_aftertax_irr', 2);
	cfline('cf_project_return_aftertax_npv', 0);
	cfline( '' ); // spacer

// LCOE
	cfline("PROJECT LEVELIZED COE AND PPA PRICE", -1);
	cfline('cf_annual_costs', 0);
	cfline('cf_energy_value', 0);
	cfline('cf_energy_net', 0); 
	cfline( '' );
	cfline('npv_annual_costs',0 );
	cfline('npv_energy_nom', 0);
	cfline('lcoe_nom',2);
	cfline( '' );
	cfline('npv_ppa_revenue', 0);
	cfline('npv_energy_nom', 0);
	cfline('lppa_nom',2);
	cfline( '' );

	cfline( "**PARTNER CASH FLOWS**", -1 );
	cfline( '' );

	cfline( 'TAX INVESTOR PRE-TAX RETURNS', -1);
	cfline('cf_tax_investor_pretax', 0);//"Total tax investor pre-tax returns");
	cfline ( '' );
	cfline('cf_tax_investor_pretax_irr', 2);//"Tax investor cumulative IRR");
	cfline('cf_tax_investor_pretax_npv', 0);//"Tax investor cumulative NPV");
	cfline( '' ); // spacer

	cfline( 'TAX INVESTOR AFTER-TAX RETURNS', -1);
	cfline('cf_tax_investor_aftertax_cash', 0);//"Tax investor cash (total pre-tax returns)");
	cfline('cf_tax_investor_aftertax_itc', 0);//"ITC");
	cfline('cf_tax_investor_aftertax_ptc', 0);//"PTC");
	cfline('cf_tax_investor_aftertax_tax', 0);//Tax investor share of project tax");
	cfline('cf_tax_investor_aftertax', 0);//Total tax investor after-tax returns");
	cfline( '' );
	cfline('cf_tax_investor_aftertax_irr', 2);//Tax investor cumulative IRR");
	cfline('cf_tax_investor_aftertax_npv', 0);//Tax investor cumulative NPV");
	cfline('cf_tax_investor_aftertax_max_irr', 2);//Tax investor maximum IRR");
	cfline( '' ); // spacer

	cfline('DEVELOPER PRE-TAX RETURNS', -1);
	cfline('cf_sponsor_pretax', 0);//"Total developer pre-tax returns");
	cfline('');
	cfline('cf_sponsor_pretax_irr', 2);//"Developer pre-tax cumulative IRR");
	cfline('cf_sponsor_pretax_npv', 0);//"Developer pre-tax cumulative NPV");
	cfline('');
	cfline('sponsor_pretax_irr', 2);//"Developer pre-tax IRR");
	cfline('sponsor_pretax_npv', 0);//"Developer pre-tax NPV");
	cfline( '' ); // spacer
	
	cfline( 'DEVELOPER AFTER-TAX RETURNS', -1);
	cfline('cf_sponsor_pretax', 0);
	cfline('sponsor_aftertax_equity', 0);//"Equity Investment");
	cfline('sponsor_aftertax_development', 0);//"Development Fee");
	cfline('cf_sponsor_aftertax_itc', 0);//"ITC");
	cfline('cf_sponsor_aftertax_ptc', 0);//"PTC");
	cfline('cf_sponsor_aftertax_tax', 0);//"Developer share of project tax");
	cfline('cost_dev_fee_tax_liability',0,-1,1);
	cfline('cf_sponsor_aftertax', 0);//"Total developer after-tax returns");, includes tax paid in Year 1 on development fee that is not shown in developer share of tax

	cfline('');
	cfline('cf_sponsor_aftertax_irr', 2);//"Developer after-tax cumulative IRR");
	cfline('cf_sponsor_aftertax_npv', 0);//"Developer after-tax cumulative NPV");
	cfline('');
	cfline('sponsor_aftertax_irr', 2);//"Developer after-tax IRR");
	cfline('sponsor_aftertax_npv', 0);//"Developer after-tax NPV");
	cfline( '' ); // spacer

	// incentives
	cfline( 'INCENTIVES', -1);
	cf_cash_incentives();
	cfline( 'cf_ptc_fed,cf_ptc_sta' );
	cfline( '' );
	cfline( 'itc_total_fed,itc_total_sta', 0, 1, 1); // offset to year 1
	cfline( '' );

	// debt
	cfline( "DEBT REPAYMENT", -1);
	cfline('cf_debt_payment_total', 0);
	cfline('cf_debt_payment_interest', 0);
	cfline('cf_debt_payment_principal', 0);
	cfline('cf_debt_balance', 0);
	cfline( '' ); // spacer
	
	if ( value('debt_option') == 0 ) {
	  cfline( "DSCR (DEBT FRACTION)", -1);
	  cfline('cf_ebitda', 0);
	  cfline("minus:", -1, 0);
	  cfline('cf_reserve_equip1', 0);
	  cfline('cf_reserve_equip2', 0);
	  cfline('cf_reserve_equip3', 0);
	  cfline("equals:", -1, 0);
  	  cfline('cf_cash_for_ds', 0);
      cfline('cf_debt_payment_total', 0);
      cfline('cf_pretax_dscr', 2);
	}
    if ( value('debt_option') == 1 ) {
	  cfline( "DEBT SIZING (SCULPTED DEBT PAYMENTS)", -1);
	  cfline('cf_ebitda', 0);
	  cfline("minus:", -1, 0);
	  cfline('cf_reserve_equip1', 0);
	  cfline('cf_reserve_equip2', 0);
	  cfline('cf_reserve_equip3', 0);
	  cfline("equals:", -1, 0);
	  cfline('cf_cash_for_ds', 0);
	  cfline('cf_pv_interest_factor', 2);
	  cfline('cf_pv_cash_for_ds', 0);
      cfline('cf_pretax_dscr', 2);
	  cfline('cf_debt_size', 0);
    }
	cfline( '' );

	// Reserves
	cfline("RESERVES", -1);
	cfline( '' );
	cfline('cf_funding_debtservice', 0);
	cfline('cf_disbursement_debtservice', 0);
	cfline('cf_reserve_debtservice', 0);
	cfline( '' );
	cfline('cf_funding_om', 0);
	cfline('cf_disbursement_om', 0);
	cfline('cf_reserve_om', 0);
	cfline( '' );
	cfline('cf_funding_receivables', 0);
	cfline('cf_disbursement_receivables', 0);
	cfline('cf_reserve_receivables', 0);
	cfline( '' );
	cfline('cf_funding_equip1', 0);
	cfline('cf_disbursement_equip1', 0);
	cfline('cf_reserve_equip1', 0);
	cfline( '' );
	cfline('cf_funding_equip2', 0);
	cfline('cf_disbursement_equip2', 0);
	cfline('cf_reserve_equip2', 0);
	cfline( '' );
	cfline('cf_funding_equip3', 0);
	cfline('cf_disbursement_equip3', 0);
	cfline('cf_reserve_equip3', 0);
	cfline( '' );
	cfline( '' );
	// state and federal depreciation/itc tables
	state_federal_depreciation_tables();
};

cashflow{ 'All Equity Partnership Flip' } = define()
{

	cfline( "PRODUCTION (AC KWH)",-1);
	cfline( 'cf_energy_net', 0); // no decimal places with thousands separator

	cfline( '' ); // spacer with no shading
	cfline("REVENUES", -1);
	cfline( 'cf_ppa_price' , -2 ); // generic formatting to show all significant digits
	cfline( 'cf_energy_value', 0);
	cfline( 'cf_net_salvage_value', 0);
	cfline( 'cf_total_revenue', 0);
	cfline( '' ); // spacer

	cfline( 'cf_property_tax_assessed_value', 0);
	cfline( '' ); // spacer

	cfline("OPERATING EXPENSES", -1);
	cf_om_expenses();
	cfline( 'cf_property_tax_expense', 0);
	cfline( 'cf_insurance_expense', 0);
	cfline( 'cf_operating_expenses', 0);
	cfline( '' ); // spacer
	
	cfline( 'cf_ebitda', 0);
	cfline( '' ); // spacer

	cfline("**PROJECT CASH FLOWS**", -1);
	cfline( '' ); // spacer
	
	cfline("PROJECT OPERATING ACTIVITIES", -1, 0);
	cfline( 'cf_ebitda', 0);
	cfline( 'cf_reserve_interest', 0);
	cfline('cf_project_operating_activities', 0);
	cfline( '' ); // spacer

	cfline( "PROJECT INVESTING ACTIVITIES", -1);
	cfline('cost_prefinancing',0,-1,0);
	cfline('cost_equity_closing',0,-1,0);
	cfline('cost_dev_fee_value',0,-1,0);
	cfline('cost_other_financing',0,-1,0);
	cfline('construction_financing_cost',0,-1,0);
	cfline( 'ibi_total', 0);
	cfline( 'cbi_total', 0);
	cfline("equals:", -1, 0);
	cfline( 'purchase_of_property', 0);
	cfline("plus:", -1, 0);

	cfline( 'cf_project_wcra', 0);
	cfline('cf_project_receivablesra', 0);
	cfline('cf_project_me1ra', 0);
	cfline('cf_project_me2ra', 0);
	cfline('cf_project_me3ra', 0);
	cfline('cf_project_me1cs', 0);
	cfline('cf_project_me2cs', 0);
	cfline('cf_project_me3cs', 0);
	cfline("equals:", -1, 0);	
	cfline('cf_project_investing_activities', 0);
	cfline( '' ); // spacer

	cfline( "PROJECT FINANCING ACTIVITIES", -1);
	cfline( 'issuance_of_equity',0);
	cfline( 'ibi_total', 0);
	cfline( 'cbi_total', 0);
	cfline('cf_project_financing_activities', 0);
	cfline( '' ); // spacer

	cfline( "PROJECT PRE-TAX RETURNS", -1);
	cfline('cf_project_operating_activities', 0);
	cfline('cf_project_investing_activities', 0);	
	cfline('cf_project_financing_activities', 0);
	cfline("equals:", -1, 0);
	cfline('cf_pretax_cashflow', 0);
	cfline("plus:", -1, 0);
	cfline( 'issuance_of_equity',0,-1,0);
	cfline("equals:", -1, 0);
	cfline('cf_pretax_cashflow', 0);
	//cfline('cf_project_return_pretax', 0); from LPF
	cfline( '' ); // spacer

	cfline( "PROJECT PRE-TAX IRR AND NPV", -1);
	cfline('cf_project_return_pretax_irr', 2);
	cfline('cf_project_return_pretax_npv', 0);
	cfline( '' ); // spacer

	cfline( "PROJECT AFTER-TAX RETURNS", -1, 0);
	cfline('cf_project_return_pretax', 0);
	cfline('itc_total_fed', 0, 1, 1 ); // offset column to year 1
	cfline('cf_ptc_fed', 0);
	cfline('cf_federal_tax_frac',0);
	cfline('cf_fedtax_income_with_incentives',0);
	cfline('cf_fedtax', 0);
	cfline('itc_total_sta', 0);
	cfline('cf_ptc_sta', 0);
	cfline('cf_state_tax_frac',0);
	cfline('cf_statax_income_with_incentives',0);
	cfline('cf_statax', 0);
//	cfline('cf_project_return_aftertax_cash', 0);
	cfline('cf_project_return_aftertax', 0);
	cfline( '' );
	
	cfline( "PROJECT AFTER-TAX IRR AND NPV", -1);
	cfline('cf_project_return_aftertax_irr', 2);
	cfline('cf_project_return_aftertax_npv', 0);
	cfline( '' ); // spacer

	// LCOE
	cfline("PROJECT LEVELIZED COE AND PPA PRICE", -1);

	cfline('cf_annual_costs', 0);
	cfline('cf_energy_value', 0);
	cfline('cf_energy_net', 0); 
	cfline( '' );
	cfline('npv_annual_costs',0 );
	cfline('npv_energy_nom', 0);
	cfline('lcoe_nom',2);
	cfline( '' );
	cfline('npv_ppa_revenue', 0);
	cfline('npv_energy_nom', 0);
	cfline('lppa_nom',2);
	cfline( '' );

	cfline( "**PARTNER CASH FLOWS**", -1 );
	cfline( '' );

	cfline( 'TAX INVESTOR PRE-TAX RETURNS', -1);

	cfline('cf_tax_investor_pretax', 0);//"Total tax investor pre-tax returns");
	cfline ( '' );
	cfline('cf_tax_investor_pretax_irr', 2);//"Tax investor cumulative IRR");
	cfline('cf_tax_investor_pretax_npv', 0);//"Tax investor cumulative NPV");
	cfline( '' ); // spacer

	cfline( 'TAX INVESTOR AFTER-TAX RETURNS', -1);

	cfline('cf_tax_investor_aftertax_cash', 0);//"Tax investor cash (total pre-tax returns)");
	cfline('cf_tax_investor_aftertax_itc', 0);//"ITC");
	cfline('cf_tax_investor_aftertax_ptc', 0);//"PTC");
	cfline('cf_tax_investor_aftertax_tax', 0);//Tax investor share of project tax");
	cfline('cf_tax_investor_aftertax', 0);//Total tax investor after-tax returns");
	cfline( '' );
	cfline('cf_tax_investor_aftertax_irr', 2);//Tax investor cumulative IRR");
	cfline('cf_tax_investor_aftertax_npv', 0);//Tax investor cumulative NPV");
	cfline('cf_tax_investor_aftertax_max_irr', 2);//Tax investor maximum IRR");
	cfline( '' ); // spacer

	cfline('DEVELOPER CAPITAL RECOVERY', -1);
	cfline('cf_sponsor_capital_recovery_cash', 0);
	cfline('cf_sponsor_capital_recovery_balance', 0);
	cfline( '' ); // spacer
	
	cfline('DEVELOPER PRE-TAX RETURNS', -1);

	cfline('sponsor_pretax_equity', 0);//"Developer Pre-tax Returns");
	cfline('');
	cfline('cf_sponsor_pretax_irr', 2);//"Developer pre-tax cumulative IRR");
	cfline('cf_sponsor_pretax_npv', 0);//"Developer pre-tax cumulative NPV");
	cfline('');
	cfline('sponsor_pretax_irr', 2);//"Developer pre-tax IRR");
	cfline('sponsor_pretax_npv', 0);//"Developer pre-tax NPV");
	cfline( '' ); // spacer

	cfline( 'DEVELOPER AFTER-TAX RETURNS', -1);
	cfline('cf_sponsor_pretax', 0);
	cfline('sponsor_aftertax_equity', 0);//"Equity Investment");
	cfline('sponsor_aftertax_development', 0);//"Development Fee");
	cfline('cf_sponsor_aftertax_itc', 0);//"ITC");
	cfline('cf_sponsor_aftertax_ptc', 0);//"PTC");
	cfline('cf_sponsor_aftertax_tax', 0);//"Developer share of project tax");
	cfline('cost_dev_fee_tax_liability',0,-1,1);
	cfline('cf_sponsor_aftertax', 0);//"Total developer after-tax returns");, includes tax paid in Year 1 on development fee that is not shown in developer share of tax

	cfline('');
	cfline('cf_sponsor_aftertax_irr', 2);//"Developer after-tax cumulative IRR");
	cfline('cf_sponsor_aftertax_npv', 0);//"Developer after-tax cumulative NPV");
	cfline('');
	cfline('sponsor_aftertax_irr', 2);//"Developer after-tax IRR");
	cfline('sponsor_aftertax_npv', 0);//"Developer after-tax NPV");
	cfline( '' ); // spacer

	// incentives
	cfline( 'INCENTIVES', -1);
	cf_cash_incentives();
	cfline( 'cf_ptc_fed,cf_ptc_sta' );
	cfline( '' );
	cfline( 'itc_total_fed,itc_total_sta', 0, 1, 1); // offset to year 1
	cfline( '' );

	// reserve accounts
	cfline( 'RESERVE ACCOUNT FUNDING', -1);

	cfline('cf_reserve_om', 0);
	cfline('cf_reserve_receivables', 0);
	cfline('cf_reserve_equip1', 0);
	cfline('cf_reserve_equip2', 0);
	cfline('cf_reserve_equip3', 0);
	cfline( '' ); // spacer

	// state and federal depreciation/itc tables
	state_federal_depreciation_tables();
};	

/*
cashflow{ 'Sale Leaseback' } = define()
{
	cfline('Partial Income Statement: Project', -1);
   	tech = technology();

    	fueltech = ( tech != 'Flat Plate PV' && 
                 tech != 'PVWatts' && 
                 tech != 'High-X Concentrating PV' && 
                 tech != 'Solar Water Heating' && 
                 tech != 'Wind Power');
    
	cfline( 'cf_energy_net', 0); // use one digit
	cfline( 'cf_ppa_price' , -2 );
	cfline( 'cf_energy_value', 0);
	cfline( 'cf_net_salvage_value', 0);

	cfline( 'cf_total_revenue', 0);

	cfline( '' ); // spacer

	cfline( 'cf_property_tax_assessed_value', 0);

	cfline( '' ); // spacer

	cfline( "Expenses", -1 ); // header	
	if (value('system_use_recapitalization'))cfline('cf_recapitalization', 0);
	cfline( 'cf_om_fixed_expense,cf_om_production_expense,cf_om_capacity_expense', 0);
	if ( fueltech == true )cfline('cf_om_fuel_expense', 0);
	if ( fueltech == true )cfline('cf_om_opt_fuel_1_expense', 0);
	if ( fueltech == true )cfline('cf_om_opt_fuel_2_expense', 0);
	cfline( 'cf_property_tax_expense', 0);
	cfline( 'cf_insurance_expense', 0);
	cfline( 'cf_operating_expenses', 0);
	cfline( '' ); // spacer

	cfline('cf_sponsor_operating_margin', 0);
	cfline( '' );


	cfline('Cash Flow: Developer (Lessee LLC)', -1);
	cfline('Cash Flows from Operating Activities', -1, 0);
	cfline('cf_sponsor_operating_margin', 0);
	cfline('cf_reserve_interest', 0);
	cfline('cf_sponsor_operating_activities', 0);
	cfline( '' );
	cfline('Cash Flows from Investing Activities', -1);
	cfline('sale_of_property', 0);
	cfline('purchase_of_plant', 0);
	cfline('distribution_of_development_fee', 0);
	cfline('cf_net_salvage_value', 0);
	cfline( '' );
	cfline('cf_sponsor_wcra', 0);
	cfline('cf_sponsor_me1ra', 0);
	cfline('cf_sponsor_me2ra', 0);
	cfline('cf_sponsor_me3ra', 0);
	cfline('cf_sponsor_ra', 0);
	cfline( '' );
	cfline('cf_sponsor_me1cs', 0);
	cfline('cf_sponsor_me2cs', 0);
	cfline('cf_sponsor_me3cs', 0);
	cfline('cf_sponsor_mecs', 0);
	cfline( '' );
	cfline('cf_sponsor_investing_activities', 0);
	cfline( '' );
	cfline('Cash Flows from Financing Activities', -1);
	cfline('sponsor_equity_in_lessee_llc', 0);
	cfline('cf_sponsor_financing_activities', 0);
	cfline('cf_pretax_cashflow', 0);
	cfline('cf_sponsor_adj_reserve_release', 0);
	cfline('cf_pretax_operating_cashflow', 0);
	cfline( '' );

	cfline('Cash Flow: Tax Investor (Lessor)', -1);
	cfline('Cash Flows from Operating Activities', -1, 0);
	cfline('cf_pretax_operating_cashflow', 0);
	cfline('cf_tax_investor_operating_activities', 0);
	cfline( '' );
	cfline('Cash Flows from Investing Activities', -1);
	cfline('sale_of_property', 0);
	cfline('cf_net_salvage_value', 0);
	cfline('cf_tax_investor_investing_activities', 0);
	cfline( '' );
	cfline('Cash Flows from Financing Activities', -1);
	cfline('issuance_of_equity', 0);
	cfline('ibi_total', 0);
	cfline('cbi_total', 0);
	cfline('cf_tax_investor_financing_activities', 0);
	cfline( '' );
	cfline('cf_tax_investor_pretax_cashflow', 0);
	cfline( '' );
	cfline( '' );

// LCOE
	cfline("LEVELIZED COE AND PPA PRICE", -1);
	cfline('cf_annual_costs', 0);
	cfline('cf_energy_value', 0);
	cfline('cf_energy_net', 0); 
	cfline( '' );
	cfline('npv_annual_costs',0 );
	cfline('npv_energy_nom', 0);
	cfline('lcoe_nom',2);
	cfline( '' );
	cfline('npv_ppa_revenue', 0);
	cfline('npv_energy_nom', 0);
	cfline('lppa_nom',2);
	cfline( '' );

	cfline('Tax Investor (Lessor) Returns', -1);
	cfline('Pre-Tax', -1, 0);
	cfline('sale_of_property', 0);
	cfline('ibi_total', 0);
	cfline('cbi_total', 0);
	cfline('cf_net_salvage_value', 0);
	cfline('cf_pretax_operating_cashflow', 0);
	cfline('cf_tax_investor_pretax', 0);
	cfline('cf_tax_investor_pretax_irr', 2);
	cfline('cf_tax_investor_pretax_npv', 0);
	cfline( '' );
	cfline('After-Tax', -1, 0);
	cfline('sale_of_property', 0);
	cfline('ibi_total', 0);
	cfline('cbi_total', 0);
	cfline('cf_net_salvage_value', 0);
	cfline('cf_pretax_operating_cashflow', 0);
	cfline('cf_tax_investor_aftertax_cash', 0);
	cfline('cf_tax_investor_aftertax_itc', 0);
	cfline('cf_tax_investor_aftertax_ptc', 0);
	cfline('cf_tax_investor_aftertax_tax', 0);
	cfline('cf_tax_investor_aftertax', 0);
	cfline('cf_tax_investor_aftertax_irr', 2);
	cfline('cf_tax_investor_aftertax_npv', 0);
	cfline('cf_tax_investor_aftertax_max_irr', 2);
	cfline( '' );

	cfline('Developer (Lessee LLC) Returns', -1);
	cfline('Pre-Tax', -1, 0);
	cfline('sponsor_equity_in_lessee_llc', 0);
	cfline('distribution_of_development_fee', 0);
	cfline('Release of major equipment replacement reserves', 0); //was cf_disbursement_merr need to verify cpg 9/10/2014
	cfline('cf_disbursement_om', 0);
	cfline('cf_disbursement_leasepayment', 0);
	cfline('cf_reserve_leasepayment_interest', 0);
	cfline('cf_sponsor_margin', 0);
	cfline('cf_sponsor_pretax', 0);
	cfline('cf_sponsor_pretax_irr', 2);
	cfline('cf_sponsor_pretax_npv', 0);
	cfline('sponsor_pretax_irr', 2);
	cfline('sponsor_pretax_npv', 0);
	cfline( '' );
	cfline('After-Tax', -1, 0);
	cfline('sponsor_equity_in_lessee_llc', 0);
	cfline('distribution_of_development_fee', 0);
	cfline("Release of major equipment replacement reserves", -1, 0); //was cf_disbursement_merr need to verify cpg 9/10/2014
	cfline('cf_disbursement_om', 0);
	cfline('cf_disbursement_leasepayment', 0);
	cfline('cf_reserve_leasepayment_interest', 0);
	cfline('cf_sponsor_margin', 2);
	cfline('cf_sponsor_aftertax_cash', 0);
	cfline('cf_sponsor_aftertax_tax', 0);
	cfline('cf_sponsor_aftertax_devfee', 0);
	cfline('cf_sponsor_aftertax', 0);
	cfline('cf_sponsor_aftertax_irr', 2);
	cfline('cf_sponsor_aftertax_npv', 0);
	cfline('sponsor_aftertax_irr', 2);
	cfline('sponsor_aftertax_npv', 0);
	cfline( '' );


	// incentives
	cfline( 'Incentives', -1);
	cf_cash_incentives();
	cfline( 'cf_ptc_fed,cf_ptc_sta' );
	cfline( '' );
	cfline( 'itc_total_fed,itc_total_sta', 0, 1, 1); // offset to year 1
	cfline( '' );

	// reserve accounts
	cfline( 'Reserve Accounts', -1);
	cfline('cf_reserve_leasepayment', 0);
	cfline('cf_reserve_om', 0);
	cfline('cf_reserve_equip1', 0);
	cfline('cf_reserve_equip2', 0);
	cfline('cf_reserve_equip3', 0);
	cfline( '' ); // spacer
	cfline( '' ); // spacer

	// state and federal depreciation/itc tables
	state_federal_depreciation_tables();
};*/

cashflow{ 'Sale Leaseback' } = define()
{

	cfline( "PRODUCTION (AC KWH)",-1);
	cfline( 'cf_energy_net', 0); // no decimal places with thousands separator

	cfline( '' ); // spacer with no shading
	cfline("REVENUES", -1);
	cfline( 'cf_ppa_price' , -2 ); // generic formatting to show all significant digits
	cfline( 'cf_energy_value', 0);
	cfline( 'cf_net_salvage_value', 0);
	cfline( 'cf_total_revenue', 0);
	cfline( '' ); // spacer

	cfline( 'cf_property_tax_assessed_value', 0);
	cfline( '' ); // spacer

	cfline("OPERATING EXPENSES", -1);
	cf_om_expenses();
	cfline( 'cf_property_tax_expense', 0);
	cfline( 'cf_insurance_expense', 0);
	cfline('cf_sponsor_margin', 0);
	cfline( 'cf_operating_expenses', 0);
	cfline( '' ); // spacer
	
	cfline('cf_sponsor_operating_margin', 0);
	cfline( '' );

	cfline('Cash Flow: Developer (Lessee LLC)', -1);
	cfline('Cash Flows from Operating Activities', -1, 0);
	cfline('cf_sponsor_operating_margin', 0);
	cfline('cf_reserve_interest', 0);
	cfline('cf_sponsor_operating_activities', 0);
	cfline( '' );
	cfline('Cash Flows from Investing Activities', -1);
	cfline('sale_of_property', 0);
	cfline('purchase_of_plant', 0);
	cfline('distribution_of_development_fee', 0);
	cfline('cf_net_salvage_value', 0);
	cfline( '' );
	cfline('cf_sponsor_wcra', 0);
	cfline('cf_sponsor_receivablesra', 0);
	cfline('cf_sponsor_me1ra', 0);
	cfline('cf_sponsor_me2ra', 0);
	cfline('cf_sponsor_me3ra', 0);
	cfline('cf_sponsor_ra', 0);
	cfline( '' );
	cfline('cf_sponsor_me1cs', 0);
	cfline('cf_sponsor_me2cs', 0);
	cfline('cf_sponsor_me3cs', 0);
	cfline('cf_sponsor_mecs', 0);
	cfline( '' );
	cfline('cf_sponsor_investing_activities', 0);
	cfline( '' );
	cfline('Cash Flows from Financing Activities', -1);
	cfline('sponsor_equity_in_lessee_llc', 0);
	cfline('cf_sponsor_financing_activities', 0);
	cfline('cf_pretax_cashflow', 0);
	cfline('cf_sponsor_adj_reserve_release', 0);
	cfline('cf_pretax_operating_cashflow', 0);
	cfline( '' );

	cfline('Cash Flow: Tax Investor (Lessor)', -1);
	cfline('Cash Flows from Operating Activities', -1, 0);
	cfline('cf_pretax_operating_cashflow', 0);
	cfline('cf_tax_investor_operating_activities', 0);
	cfline( '' );
	cfline('Cash Flows from Investing Activities', -1);
	cfline('sale_of_property', 0);
	cfline('cf_net_salvage_value', 0);
	cfline('cf_tax_investor_investing_activities', 0);
	cfline( '' );
	cfline('Cash Flows from Financing Activities', -1);
	cfline('issuance_of_equity', 0);
	cfline('ibi_total', 0);
	cfline('cbi_total', 0);
	cfline('cf_tax_investor_financing_activities', 0);
	cfline( '' );
	cfline('cf_tax_investor_pretax_cashflow', 0);
	cfline( '' );
	cfline( '' );

// LCOE
	cfline("LEVELIZED COE AND PPA PRICE", -1);
	cfline('cf_annual_costs', 0);
	cfline('cf_energy_value', 0);
	cfline('cf_energy_net', 0); 
	cfline( '' );
	cfline('npv_annual_costs',0 );
	cfline('npv_energy_nom', 0);
	cfline('lcoe_nom',2);
	cfline( '' );
	cfline('npv_ppa_revenue', 0);
	cfline('npv_energy_nom', 0);
	cfline('lppa_nom',2);
	cfline( '' );

	cfline('Tax Investor (Lessor) Returns', -1);
	cfline('Pre-Tax', -1, 0);
	cfline('sale_of_property', 0);
	cfline('ibi_total', 0);
	cfline('cbi_total', 0);
	cfline('cf_net_salvage_value', 0);
	cfline('cf_pretax_operating_cashflow', 0);
	cfline('cf_tax_investor_pretax', 0);
	cfline('cf_tax_investor_pretax_irr', 2);
	cfline('cf_tax_investor_pretax_npv', 0);
	cfline( '' );
	cfline('After-Tax', -1, 0);
	cfline('sale_of_property', 0);
	cfline('ibi_total', 0);
	cfline('cbi_total', 0);
	cfline('cf_net_salvage_value', 0);
	cfline('cf_pretax_operating_cashflow', 0);
	cfline('cf_tax_investor_aftertax_cash', 0);
	cfline('cf_tax_investor_aftertax_itc', 0);
	cfline('cf_tax_investor_aftertax_ptc', 0);
	cfline('cf_tax_investor_aftertax_tax', 0);
	cfline('cf_tax_investor_aftertax', 0);
	cfline('cf_tax_investor_aftertax_irr', 2);
	cfline('cf_tax_investor_aftertax_npv', 0);
	cfline('cf_tax_investor_aftertax_max_irr', 2);
	cfline( '' );

	cfline('Developer (Lessee LLC) Returns', -1);
	cfline('Pre-Tax', -1, 0);
	cfline('sponsor_equity_in_lessee_llc', 0);
	cfline('distribution_of_development_fee', 0);
	cfline('Release of major equipment replacement reserves', 0); //was cf_disbursement_merr need to verify cpg 9/10/2014
	cfline('cf_disbursement_om', 0);
	cfline('cf_disbursement_leasepayment', 0);
	cfline('cf_reserve_leasepayment_interest', 0);
	cfline('cf_sponsor_margin', 0);
	cfline('cf_sponsor_pretax', 0);
	cfline('cf_sponsor_pretax_irr', 2);
	cfline('cf_sponsor_pretax_npv', 0);
	cfline('sponsor_pretax_irr', 2);
	cfline('sponsor_pretax_npv', 0);
	cfline( '' );
	cfline('After-Tax', -1, 0);
	cfline('sponsor_equity_in_lessee_llc', 0);
	cfline('distribution_of_development_fee', 0);
	cfline("Release of major equipment replacement reserves", -1, 0); //was cf_disbursement_merr need to verify cpg 9/10/2014
	cfline('cf_disbursement_om', 0);
	cfline('cf_disbursement_leasepayment', 0);
	cfline('cf_reserve_leasepayment_interest', 0);
	cfline('cf_sponsor_margin', 2);
	cfline('cf_sponsor_aftertax_cash', 0);
	cfline('cf_sponsor_aftertax_tax', 0);
	cfline('cf_sponsor_aftertax_devfee', 0);
	cfline('cf_sponsor_aftertax', 0);
	cfline('cf_sponsor_aftertax_irr', 2);
	cfline('cf_sponsor_aftertax_npv', 0);
	cfline('sponsor_aftertax_irr', 2);
	cfline('sponsor_aftertax_npv', 0);
	cfline( '' );


	// incentives
	cfline( 'Incentives', -1);
	cf_cash_incentives();
	cfline( 'cf_ptc_fed,cf_ptc_sta' );
	cfline( '' );
	cfline( 'itc_total_fed,itc_total_sta', 0, 1, 1); // offset to year 1
	cfline( '' );

	// reserve accounts
	cfline( 'Reserve Accounts', -1);
	cfline('cf_reserve_leasepayment', 0);
	cfline('cf_reserve_om', 0);
	cfline('cf_reserve_receivables', 0);
	cfline('cf_reserve_equip1', 0);
	cfline('cf_reserve_equip2', 0);
	cfline('cf_reserve_equip3', 0);
	cfline( '' ); // spacer
	cfline( '' ); // spacer

	// state and federal depreciation/itc tables
	state_federal_depreciation_tables();
};

function send_excel( xl, variable)
{
	xl_set( xl, value(variable), variable );
}

function send_excel_yesno( xl, variable )
{
	y_n = 'No';
	if ( value(variable) == 1 ) y_n = 'Yes';
	xl_set( xl, y_n, variable );
}

function send_excel_depr( xl, variable )
{
	depr = '5-yr MACRS';
	if ( value(variable) == 1 ) depr = '15-yr MACRS';
	elseif ( value(variable) == 2 ) depr = '5-yr SL';
	elseif ( value(variable) == 3 ) depr = '15-yr SL';
	elseif ( value(variable) == 4 ) depr = '20-yr SL';
	elseif ( value(variable) == 5 ) depr = '39-yr SL';
	elseif ( value(variable) == 6 ) depr = 'Custom';
	xl_set( xl, depr, variable );
}

function send_excel_fuel(xl)
{
	tech = technology();
	if ( varinfo('system_heat_rate') != null ) xl_set( xl, output('system_heat_rate'),'system_heat_rate' );
	if ( varinfo('annual_fuel_usage') != null && tech != "Biopower" ) //biopower annual_fuel_usage is total energy in thermal kWh
	{
		xl_set( xl, output('annual_fuel_usage'), 'annual_fuel_usage');
		xl_set( xl, value('om_fuel_cost'),'om_fuel_cost');
		xl_set( xl, value('om_fuel_cost_escal'), 'om_fuel_cost_escal');
	} 
	if ( varinfo('om_opt_fuel_1_usage') != null )
	{
		xl_set( xl, value('om_opt_fuel_1_usage'), 'om_opt_fuel_1_usage');
		xl_set( xl, value('om_opt_fuel_1_cost'), 'om_opt_fuel_1_cost');
		xl_set( xl, value('om_opt_fuel_1_cost_escal'), 'om_opt_fuel_1_cost_escal');
	} 
	if ( varinfo('om_opt_fuel_2_usage') != null )
	{
		xl_set( xl, value('om_opt_fuel_2_usage'), 'om_opt_fuel_2_usage');
		xl_set( xl, value('om_opt_fuel_2_cost'), 'om_opt_fuel_2_cost');
		xl_set( xl, value('om_opt_fuel_2_cost_escal'), 'om_opt_fuel_2_cost_escal');
	} 
}

function send_excel_incentives(xl)
{

	send_excel(       xl, 'ibi_fed_amount');
	send_excel_yesno( xl, 'ibi_fed_amount_deprbas_fed');
	send_excel_yesno( xl, 'ibi_fed_amount_deprbas_sta');
	send_excel_yesno( xl, 'ibi_fed_amount_tax_fed');
	send_excel_yesno( xl, 'ibi_fed_amount_tax_sta');
	send_excel(       xl, 'ibi_fed_percent');
	send_excel_yesno( xl, 'ibi_fed_percent_deprbas_fed');
	send_excel_yesno( xl, 'ibi_fed_percent_deprbas_sta');
	send_excel(       xl, 'ibi_fed_percent_maxvalue');
	send_excel_yesno( xl, 'ibi_fed_percent_tax_fed');
	send_excel_yesno( xl, 'ibi_fed_percent_tax_sta');
	send_excel(       xl, 'ibi_sta_amount');
	send_excel_yesno( xl, 'ibi_sta_amount_deprbas_fed');
	send_excel_yesno( xl, 'ibi_sta_amount_deprbas_sta');
	send_excel_yesno( xl, 'ibi_sta_amount_tax_fed');
	send_excel_yesno( xl, 'ibi_sta_amount_tax_sta');
	send_excel(       xl, 'ibi_sta_percent');
	send_excel_yesno( xl, 'ibi_sta_percent_deprbas_fed');
	send_excel_yesno( xl, 'ibi_sta_percent_deprbas_sta');
	send_excel(       xl, 'ibi_sta_percent_maxvalue');
	send_excel_yesno( xl, 'ibi_sta_percent_tax_fed');
	send_excel_yesno( xl, 'ibi_sta_percent_tax_sta');
	send_excel(       xl, 'ibi_uti_amount');
	send_excel_yesno( xl, 'ibi_uti_amount_deprbas_fed');
	send_excel_yesno( xl, 'ibi_uti_amount_deprbas_sta');
	send_excel_yesno( xl, 'ibi_uti_amount_tax_fed');
	send_excel_yesno( xl, 'ibi_uti_amount_tax_sta');
	send_excel(       xl, 'ibi_uti_percent');
	send_excel_yesno( xl, 'ibi_uti_percent_deprbas_fed');
	send_excel_yesno( xl, 'ibi_uti_percent_deprbas_sta');
	send_excel(       xl, 'ibi_uti_percent_maxvalue');
	send_excel_yesno( xl, 'ibi_uti_percent_tax_fed');
	send_excel_yesno( xl, 'ibi_uti_percent_tax_sta');
	send_excel(       xl, 'ibi_oth_amount');
	send_excel_yesno( xl, 'ibi_oth_amount_deprbas_fed');
	send_excel_yesno( xl, 'ibi_oth_amount_deprbas_sta');
	send_excel_yesno( xl, 'ibi_oth_amount_tax_fed');
	send_excel_yesno( xl, 'ibi_oth_amount_tax_sta');
	send_excel(       xl, 'ibi_oth_percent');
	send_excel_yesno( xl, 'ibi_oth_percent_deprbas_fed');
	send_excel_yesno( xl, 'ibi_oth_percent_deprbas_sta');
	send_excel(       xl, 'ibi_oth_percent_maxvalue');
	send_excel_yesno( xl, 'ibi_oth_percent_tax_fed');
	send_excel_yesno( xl, 'ibi_oth_percent_tax_sta');
	send_excel(       xl, 'cbi_fed_amount');
	send_excel_yesno( xl, 'cbi_fed_deprbas_fed');
	send_excel_yesno( xl, 'cbi_fed_deprbas_sta');
	send_excel(       xl, 'cbi_fed_maxvalue');
	send_excel_yesno( xl, 'cbi_fed_tax_fed');
	send_excel_yesno( xl, 'cbi_fed_tax_sta');
	send_excel(       xl, 'cbi_sta_amount');
	send_excel_yesno( xl, 'cbi_sta_deprbas_fed');
	send_excel_yesno( xl, 'cbi_sta_deprbas_sta');
	send_excel(       xl, 'cbi_sta_maxvalue');
	send_excel_yesno( xl, 'cbi_sta_tax_fed');
	send_excel_yesno( xl, 'cbi_sta_tax_sta');
	send_excel(       xl, 'cbi_uti_amount');
	send_excel_yesno( xl, 'cbi_uti_deprbas_fed');
	send_excel_yesno( xl, 'cbi_uti_deprbas_sta');
	send_excel(       xl, 'cbi_uti_maxvalue');
	send_excel_yesno( xl, 'cbi_uti_tax_fed');
	send_excel_yesno( xl, 'cbi_uti_tax_sta');
	send_excel(       xl, 'cbi_oth_amount');
	send_excel_yesno( xl, 'cbi_oth_deprbas_fed');
	send_excel_yesno( xl, 'cbi_oth_deprbas_sta');
	send_excel(       xl, 'cbi_oth_maxvalue');
	send_excel_yesno( xl, 'cbi_oth_tax_fed');
	send_excel_yesno( xl, 'cbi_oth_tax_sta');
	pbi = value('pbi_fed_amount');
	if ( #pbi == 1 ) send_excel( xl, 'pbi_fed_amount');
	else
	{
		xl_set( xl, pbi, 'AnnualPBIFederal');
		xl_set( xl, "n/a", 'pbi_fed_amount');
	}		
	send_excel(       xl, 'pbi_fed_escal');
	send_excel_yesno( xl, 'pbi_fed_tax_fed');
	send_excel_yesno( xl, 'pbi_fed_tax_sta');
	send_excel(       xl, 'pbi_fed_term');
	pbi = value('pbi_sta_amount');
	if ( #pbi == 1 ) send_excel( xl, 'pbi_sta_amount');
	else
	{
		xl_set( xl, pbi, 'AnnualPBIState');
		xl_set( xl, "n/a", 'pbi_sta_amount');
	}		
	send_excel(       xl, 'pbi_sta_escal');
	send_excel_yesno( xl, 'pbi_sta_tax_fed');
	send_excel_yesno( xl, 'pbi_sta_tax_sta');
	send_excel(       xl, 'pbi_sta_term');
	pbi = value('pbi_uti_amount');
	if ( #pbi == 1 ) send_excel( xl, 'pbi_uti_amount');
	else
	{
		xl_set( xl, pbi, 'AnnualPBIUtility');
		xl_set( xl, "n/a", 'pbi_uti_amount');
	}		
	send_excel(       xl, 'pbi_uti_escal');
	send_excel_yesno( xl, 'pbi_uti_tax_fed');
	send_excel_yesno( xl, 'pbi_uti_tax_sta');
	send_excel(       xl, 'pbi_uti_term');
	pbi = value('pbi_oth_amount');
	if ( #pbi == 1 ) send_excel( xl, 'pbi_oth_amount');
	else
	{
		xl_set( xl, pbi, 'AnnualPBIOther');
		xl_set( xl, "n/a", 'pbi_oth_amount');
	}		
	send_excel(       xl, 'pbi_oth_escal');
	send_excel_yesno( xl, 'pbi_oth_tax_fed');
	send_excel_yesno( xl, 'pbi_oth_tax_sta');
	send_excel(       xl, 'pbi_oth_term');

	send_excel(       xl, 'itc_fed_amount');
	send_excel_yesno( xl, 'itc_fed_amount_deprbas_fed');
	send_excel_yesno( xl, 'itc_fed_amount_deprbas_sta');
	send_excel(       xl, 'itc_fed_percent');
	send_excel_yesno( xl, 'itc_fed_percent_deprbas_fed');
	send_excel_yesno( xl, 'itc_fed_percent_deprbas_sta');
	send_excel(       xl, 'itc_fed_percent_maxvalue');
	send_excel(       xl, 'itc_sta_amount');
	send_excel_yesno( xl, 'itc_sta_amount_deprbas_fed');
	send_excel_yesno( xl, 'itc_sta_amount_deprbas_sta');
	send_excel(       xl, 'itc_sta_percent');
	send_excel_yesno( xl, 'itc_sta_percent_deprbas_fed');
	send_excel_yesno( xl, 'itc_sta_percent_deprbas_sta');
	send_excel(       xl, 'itc_sta_percent_maxvalue');
	
	ptc = value('ptc_fed_amount');
	if ( #ptc == 1 ) send_excel( xl, 'ptc_fed_amount');
	else
	{
		xl_set( xl, ptc, 'AnnualPTCFederal');
		xl_set( xl, "n/a", 'ptc_fed_amount');
	}		
	send_excel( xl, 'ptc_fed_term');
	send_excel( xl, 'ptc_fed_escal');
	ptc = value('ptc_sta_amount');
	if ( #ptc == 1 ) send_excel( xl, 'ptc_sta_amount');
	else
	{
		xl_set( xl, ptc, 'AnnualPTCState');
		xl_set( xl, "n/a", 'ptc_sta_amount');
	}		
	send_excel( xl, 'ptc_sta_term');
	send_excel( xl, 'ptc_sta_escal');
	
} 

function send_excel_om(xl) {

	// fixed and variable O&M costs

	omf = value('om_fixed');
	omc = value('om_capacity');
	omp = value('om_production');
		
	if ( #omf == 1 ) 
	{
		send_excel(       xl, 'om_fixed');
		send_excel(       xl, 'om_fixed_escal');
	}
	else 
	{
		xl_set( xl, omf, 'AnnualOMFixed');
		xl_set( xl, 'n/a', 'om_fixed');
		xl_set( xl, 'n/a', 'om_fixed_escal');
	}	
	
	if ( #omc == 1 ) 
	{ 
		send_excel(       xl, 'om_capacity');
		send_excel(       xl, 'om_capacity_escal');
	}
	else 
	{
		xl_set( xl, omc, 'AnnualOMCapacity');
		xl_set( xl, 'n/a', 'om_capacity');
		xl_set( xl, 'n/a', 'om_capacity_escal');
	}	
	
	if ( #omp == 1 ) {	
		send_excel(       xl, 'om_production');
		send_excel(       xl, 'om_production_escal');
	}
	else 
	{
		xl_set( xl, omp, 'AnnualOMProduction');
		xl_set( xl, 'n/a', 'om_production');
		xl_set( xl, 'n/a', 'om_production_escal');
	}
	
	// battery replacment costs
	tech = technology();
	fin = financing();
	batt_tech = is_batt_repl = false;
	 // PVWatts does not model battery replacements, flip and leasback models do not have send-to-excel with equations as of 2017.1.17
	batt_tech = ( tech == 'Flat Plate PV' && ( fin == 'Residential' || fin == 'Commercial' || fin == "Single Owner" ) );
	is_batt_repl = ( batt_tech && value('en_batt') && value('batt_replacement_option') > 0 );
	if  ( is_batt_repl == true )
	{
		send_excel( xl, 'batt_computed_bank_capacity' );
		send_excel( xl, 'batt_replacement_option' );
		send_excel( xl, 'batt_replacement_cost' );
		send_excel( xl, 'batt_replacement_cost_escal' );
		// batt_bank_replacement is not available in this context, so have to determine year of replacement cost
		repl = output('cf_battery_replacement_cost'); // array of annual replacement cost 
		sched = alloc(#repl);
		for ( i=0; i<#repl; i++ )
		{
			if ( repl[i] == 0 ) sched[i]=0;
			else sched[i]=1;
		}
		xl_set( xl, sched, 'BatteryReplSched');
	}
}

function send_excel_rescom(xl)
{

	N = value('analysis_period');
	if ( N>100 ) msgbox("The Excel workbook only shows cash flow values for a 100-year analysis period or less. Your analysis is for " + N + " years.");


	send_excel(       xl, 'system_capacity');
	send_excel(       xl, 'total_installed_cost');
	send_excel(       xl, 'debt_fraction');
	send_excel(       xl, 'loan_term');
	send_excel(       xl, 'loan_rate');
	send_excel(       xl, 'analysis_period');
	send_excel(       xl, 'inflation_rate');
	send_excel(       xl, 'real_discount_rate');
	send_excel_taxes(xl);
	send_excel(       xl, 'sales_tax_rate');
	send_excel(       xl, 'insurance_rate');
	send_excel(       xl, 'prop_tax_assessed_decline');
	send_excel(       xl, 'prop_tax_cost_assessed_percent');
	send_excel(       xl, 'property_tax_rate');
	send_excel(       xl, 'salvage_percentage');
	
	send_excel_om(xl);	
	
	send_excel_incentives(xl);
}

function send_excel_taxes(xl)
{

	tax = value('federal_tax_rate');
	t=alloc( value('analysis_period') );
	if ( #tax == 1 ) {
		send_excel( xl, 'federal_tax_rate');
		for (i=0;i<#t;i++) t[i]=tax[0];
		xl_set( xl, t, 'AnnualTaxFederal');
	}	
	else
	{
		xl_set( xl, "n/a", 'federal_tax_rate');
		xl_set( xl, tax, 'AnnualTaxFederal');
	}		

	tax = value('state_tax_rate');
	if ( #tax == 1 ) {
		send_excel( xl, 'state_tax_rate');
		for (i=0;i<#t;i++) t[i]=tax[0];
		xl_set( xl, t, 'AnnualTaxState');
	}	
	else
	{
		xl_set( xl, "n/a", 'state_tax_rate');
		xl_set( xl, tax, 'AnnualTaxState');
	}		

}

cashflow_to_excel{ 'Residential' } = define()
{

	source = runtimedir() + 'spreadsheets/residential_commercial.xlsx';
    fn = case_name() + '.xlsx';
	destination = cwd();
	destination = choose_file(destination,"Save workbook","Excel Workbook (*.xlsx)|*.xlsx",true, false, fn);
	destination = copy_file( source, destination, true);
	if (!file_exists(destination)) return;
	cwd(path_only(destination));
	
	xl = xl_create( destination );

	//Variables specific to residential model
	xl_set( xl, (${mortgage}?"Yes":"No"), 'UseTaxDeductibleInterest');
	xl_set( xl, "N/A", 'StateDepreciation');
	xl_set( xl, "N/A", 'FederalDepreciation');

	send_excel_rescom(xl);
	send_excel_fuel(xl);

	xl_set ( xl, output('cf_energy_net'), "AnnualEnergy");
	xl_set ( xl, output('cf_energy_value'), "EnergyValue");

//	xl_free( xl ); // closes workbook

};

cashflow_to_excel{ 'Commercial' } = define()
{

	source = runtimedir() + 'spreadsheets/residential_commercial.xlsx';
    fn = case_name() + '.xlsx';
	destination = cwd();
	destination = choose_file(destination,"Save workbook","Excel Workbook (*.xlsx)|*.xlsx",true, false, fn);
	destination = copy_file( source, destination, true);
	if (!file_exists(destination)) return;
	cwd(path_only(destination));
	
	xl = xl_create( destination );
	
	//Variables specific to commercial model
	xl_set( xl, "Yes", 'UseTaxDeductibleInterest');
	s = value('depr_sta_type');
	if (s == 0) state = "No Depreciation";
	if (s == 1) state = "5-yr MACRS";
	if (s == 2) state = "Straight Line" + value('depr_sta_sl_years') + " Years";
	if (s == 3) state = "Custom (see cash flow)";
	xl_set( xl, state, 'StateDepreciation'); //show depreciation type in inputs table for reference only
	f = value('depr_fed_type'); //show depreciation percentages in cash flow for calculations
	if (f == 0) fed = "No Depreciation";
	if (f == 1) fed = "5-yr MACRS";
	if (f == 2) fed = "Straight Line" + value('depr_sta_sl_years') + " Years";
	if (f == 3) fed = "Custom (see cash flow)";
	xl_set( xl, fed, 'FederalDepreciation');

	send_excel_rescom(xl);
	send_excel_fuel(xl);

	xl_set ( xl, output('cf_energy_net'), "AnnualEnergy");
	xl_set ( xl, output('cf_energy_value'), "EnergyValue");
	xl_set ( xl, output('cf_sta_depr_sched'), "StateDepreciationSchedule");
	xl_set ( xl, output('cf_fed_depr_sched'), "FederalDepreciationSchedule");

//	xl_free( xl ); // closes workbook

};

cashflow_to_excel{ 'Single Owner' } = define() 
{

	source = runtimedir() + 'spreadsheets/single_owner.xlsx';
    fn = case_name() + '.xlsx';
	destination = cwd();
	destination = choose_file(destination,"Save workbook","Excel Workbook (*.xlsx)|*.xlsx",true, false, fn);
	destination = copy_file( source, destination, true);
	if (!file_exists(destination)) return;
	cwd(path_only(destination));
	
	xl = xl_create( destination );

	N = value('analysis_period');
	if ( N>40 ) msgbox("The Excel workbook only shows cash flow values for a 40-year analysis period or less. Your analysis is for " + N + " years.");
	
	//send DSCR or debt fraction depending on debt sizing mode
	if ( value('debt_option') == 0 ) // debt fraction input mode (constant payments)
	{
		xl_set( xl, value('debt_percent'), "DebtPercent");
		xl_set( xl, "Calculated", "DebtServiceCoverageRatio");
		xl_set( xl, output('size_of_debt'), "MortgageSizeOfDebt");
		send_excel(  xl, 'loan_moratorium');
	}
	else // dscr input mode (sculpted debt payments, constant DSCR)
	{
		xl_set( xl, value('dscr'), "DebtServiceCoverageRatio");
		xl_set( xl, "Calculated", "DebtPercent");
		xl_set( xl, "N/A", "MortgageSizeOfDebt");
		xl_set( xl, "0", "loan_moratorium" ); //ensure that loan moratorium is zero so Excel cash flow formulas work correctly
	}
	
	//send debt service reserve cash flow items because of iteration with debt fraction input option
	xl_set( xl, output('cf_reserve_debtservice'), 'cf_reserve_debtservice');
	xl_set( xl, output('cf_funding_debtservice'), 'cf_funding_debtservice');
	xl_set( xl, output('cf_disbursement_debtservice'), 'cf_disbursement_debtservice');
	
	//send payment option flag
	if ( value('payment_option') == 0 ) // equal payments
		xl_set( xl, "Equal payments", "DebtPayment");
	else // fixed principal	
		xl_set( xl, "Fixed principal", "DebtPayment");
		
	//export annual values to minimize rounding discrepancies between SAM and workbook
	xl_set( xl, output('cf_energy_net'), "AnnualEnergy");
	xl_set( xl, output('cf_ppa_price'), "AnnualPPAPrice");
	xl_set( xl, output('cf_energy_value'), "AnnualPPARevenue");
		
	//determine whether to send ppa price and irr inputs or outputs depending on solution mode
	send_excel( xl, 'ppa_escalation'); 	
	if ( value('ppa_soln_mode') == 0 ) //IRR is input
	{
		xl_set( xl, value('flip_target_percent'), "IRRTarget");
		xl_set( xl, value('flip_target_year'), "IRRTargetYear");
		xl_set( xl, "Calculated", "PPAPriceInput" ); 
	}
	else //PPA price is input
	{
		xl_set( xl, "Calculated", "IRRTarget");
		xl_set( xl, "Calculated", "IRRTargetYear");
		xl_set( xl, value('ppa_price_input'), "PPAPriceInput" ); 
	}
		
	//show construction financing cost calculation in spreadsheet
	//(ssc only uses total cost as input, so these are UI inputs from input form)
	send_excel( xl, 'const_per_percent1');
	send_excel( xl, 'const_per_percent2');
	send_excel( xl, 'const_per_percent3');
	send_excel( xl, 'const_per_percent4');
	send_excel( xl, 'const_per_percent5');
	send_excel( xl, 'const_per_upfront_rate1');
	send_excel( xl, 'const_per_upfront_rate2');
	send_excel( xl, 'const_per_upfront_rate3');
	send_excel( xl, 'const_per_upfront_rate4');
	send_excel( xl, 'const_per_upfront_rate5');
	send_excel( xl, 'const_per_months1');
	send_excel( xl, 'const_per_months2');
	send_excel( xl, 'const_per_months3');
	send_excel( xl, 'const_per_months4');
	send_excel( xl, 'const_per_months5');
	send_excel( xl, 'const_per_interest_rate1');
	send_excel( xl, 'const_per_interest_rate2');
	send_excel( xl, 'const_per_interest_rate3');
	send_excel( xl, 'const_per_interest_rate4');
	send_excel( xl, 'const_per_interest_rate5');		

	send_excel_incentives(xl);
	send_excel_yesno( xl, 'pbi_fed_for_ds');
	send_excel_yesno( xl, 'pbi_sta_for_ds');
	send_excel_yesno( xl, 'pbi_oth_for_ds');
	send_excel_yesno( xl, 'pbi_uti_for_ds');

	send_excel_om(xl);
	send_excel_fuel(xl);
	
	send_excel(       xl, 'analysis_period');
	send_excel(       xl, 'construction_financing_cost');
	send_excel(       xl, 'cost_debt_closing');
	send_excel(       xl, 'cost_debt_fee');
	xl_set( xl, output('cost_debt_upfront'), 'CostDebtUpfront' );
	send_excel(       xl, 'cost_other_financing');
	send_excel(       xl, 'depr_alloc_macrs_15_percent');
	send_excel(       xl, 'depr_alloc_macrs_5_percent');
	send_excel(       xl, 'depr_alloc_sl_15_percent');
	send_excel(       xl, 'depr_alloc_sl_20_percent');
	send_excel(       xl, 'depr_alloc_sl_39_percent');
	send_excel(       xl, 'depr_alloc_sl_5_percent');
	send_excel(       xl, 'depr_bonus_fed');
	send_excel_yesno( xl, 'depr_bonus_fed_macrs_15');
	send_excel_yesno( xl, 'depr_bonus_fed_macrs_5');
	send_excel_yesno( xl, 'depr_bonus_fed_sl_15');
	send_excel_yesno( xl, 'depr_bonus_fed_sl_20');
	send_excel_yesno( xl, 'depr_bonus_fed_sl_39');
	send_excel_yesno( xl, 'depr_bonus_fed_sl_5');
	send_excel(       xl, 'depr_bonus_sta');
	send_excel_yesno( xl, 'depr_bonus_sta_macrs_15');
	send_excel_yesno( xl, 'depr_bonus_sta_macrs_5');
	send_excel_yesno( xl, 'depr_bonus_sta_sl_15');
	send_excel_yesno( xl, 'depr_bonus_sta_sl_20');
	send_excel_yesno( xl, 'depr_bonus_sta_sl_39');
	send_excel_yesno( xl, 'depr_bonus_sta_sl_5');
	send_excel_yesno( xl, 'depr_itc_fed_macrs_15');
	send_excel_yesno( xl, 'depr_itc_fed_macrs_5');
	send_excel_yesno( xl, 'depr_itc_fed_sl_15');
	send_excel_yesno( xl, 'depr_itc_fed_sl_20');
	send_excel_yesno( xl, 'depr_itc_fed_sl_39');
	send_excel_yesno( xl, 'depr_itc_fed_sl_5');
	send_excel_yesno( xl, 'depr_itc_sta_macrs_15');
	send_excel_yesno( xl, 'depr_itc_sta_macrs_5');
	send_excel_yesno( xl, 'depr_itc_sta_sl_15');
	send_excel_yesno( xl, 'depr_itc_sta_sl_20');
	send_excel_yesno( xl, 'depr_itc_sta_sl_39');
	send_excel_yesno( xl, 'depr_itc_sta_sl_5');
	
//	send_excel(       xl, 'dscr'); //input
	send_excel(       xl, 'dscr_reserve_months');
	send_excel(       xl, 'months_working_reserve');
	send_excel(       xl, 'months_receivables_reserve');
	send_excel_depr(  xl, 'equip_reserve_depr_fed');
	send_excel_depr(  xl, 'equip_reserve_depr_sta');
	send_excel(       xl, 'equip1_reserve_cost');
	send_excel(       xl, 'equip1_reserve_freq');
	send_excel(       xl, 'equip2_reserve_cost');
	send_excel(       xl, 'equip2_reserve_freq');
	send_excel(       xl, 'equip3_reserve_cost');
	send_excel(       xl, 'equip3_reserve_freq');

	send_excel_taxes(xl);
	
	send_excel(       xl, 'inflation_rate');
	send_excel(       xl, 'insurance_rate');
	send_excel(       xl, 'prop_tax_assessed_decline');
	send_excel(       xl, 'prop_tax_cost_assessed_percent');
	send_excel(       xl, 'property_tax_rate');
	send_excel(       xl, 'real_discount_rate');
	send_excel(       xl, 'reserves_interest');
	send_excel(       xl, 'sales_tax_rate');
	send_excel(       xl, 'salvage_percentage');

	send_excel(       xl, 'system_capacity');
	send_excel(       xl, 'term_int_rate');
	send_excel(       xl, 'term_tenor');
	//loan_moratorium sent above in debt_option if statement
	send_excel(       xl, 'total_installed_cost');
	
//	xl_free( xl ); // closes workbook
};

cashflow_to_excel{ 'Leveraged Partnership Flip' } = define()
{
	msgbox("Send Cash Flow to Excel with Equations for the Leveraged Partnership Flip financial model is not available in this version of SAM.\n\nSee the Financial Model Documentation page on the SAM website (sam.nrel.gov/financial) for spreadsheet versions of all of SAM's financial models.");
};

cashflow_to_excel{ 'All Equity Partnership Flip' } = define()
{
	msgbox("Send Cash Flow to Excel with Equations for the All Equity Partnership Flip financial model is not available in this version of SAM.\n\nSee the Financial Model Documentation page on the SAM website (sam.nrel.gov/financial) for spreadsheet versions of all of SAM's financial models.");
};

cashflow_to_excel{ 'Sale Leaseback' } = define()
{
	msgbox("Send Cash Flow to Excel with Equations for the Sale Leaseback financial model is not available in this version of SAM.\n\nSee the Financial Model Documentation page on the SAM website (sam.nrel.gov/financial) for spreadsheet versions of all of SAM's financial models.");
};
