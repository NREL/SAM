Solar Resource Data Old
886
766
38
GroupBox

1
8
Name
5
9
GroupBox2
X
3
9
Y
3
150
Width
3
870
Height
3
504
Tool Tip
5
0
Caption
5
22
Solar Resource Library
Bold
2
1
Hyperlink

1
9
Name
5
10
Hyperlink2
X
3
690
Y
3
123
Width
3
186
Height
3
21
Tool Tip
5
0
Caption
5
26
International Data Sources
URL
5
33
https://sam.nrel.gov/weather-data
TabOrder
3
0
Numeric

1
17
Name
5
11
annual_beam
X
3
174
Y
3
402
Width
3
103
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
0
Decimals
3
2
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
0
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
Numeric

1
17
Name
5
14
annual_diffuse
X
3
174
Y
3
432
Width
3
103
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
0
Decimals
3
2
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
0
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
Numeric

1
17
Name
5
13
annual_global
X
3
174
Y
3
372
Width
3
103
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
0
Decimals
3
2
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
0
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
Numeric

1
17
Name
5
11
annual_snow
X
3
510
Y
3
432
Width
3
103
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
0
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
0
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
Numeric

1
17
Name
5
11
annual_tdry
X
3
510
Y
3
369
Width
3
103
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
0
Decimals
3
1
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
0
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
Numeric

1
17
Name
5
11
annual_wspd
X
3
510
Y
3
402
Width
3
103
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
0
Decimals
3
1
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
0
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
TextEntry

1
11
Name
5
4
city
X
3
63
Y
3
258
Width
3
208
Height
3
24
Tool Tip
5
0
Text
5
9
Your City
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
6
TextEntry

1
11
Name
5
7
country
X
3
63
Y
3
321
Width
3
97
Height
3
24
Tool Tip
5
0
Text
5
3
usa
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
7
Button

1
8
Name
5
21
download_weather_file
X
3
15
Y
3
81
Width
3
329
Height
3
24
Tool Tip
5
0
Caption
5
35
Download a TMY file for Americas...
TabOrder
3
1
Button

1
8
Name
5
15
dview_for_solar
X
3
675
Y
3
369
Width
3
195
Height
3
24
Tool Tip
5
0
Caption
5
25
View weather file data...
TabOrder
3
3
Numeric

1
17
Name
5
4
elev
X
3
354
Y
3
291
Width
3
103
Height
3
24
Tool Tip
5
0
Value
1
317
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
2
 m
ThousandsSep
2
0
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
9
Numeric

1
17
Name
5
3
lat
X
3
546
Y
3
261
Width
3
103
Height
3
24
Tool Tip
5
0
Value
1
1.1
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
3
 °N
ThousandsSep
2
0
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
10
Label

1
13
Name
5
7
lbl_csp
X
3
15
Y
3
108
Width
3
640
Height
3
36
Tool Tip
5
0
Caption
5
108
SAM's CSP models use a different time convention for weather data than the NREL NSRDB. See Help for details.
TextColour
4
255
0
0
255
Bold
2
0
FontSize
3
0
WordWrap
2
1
AlignRight
2
0
AlignTop
2
1
Numeric

1
17
Name
5
3
lon
X
3
546
Y
3
291
Width
3
103
Height
3
24
Tool Tip
5
0
Value
1
1.2
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
3
 °E
ThousandsSep
2
0
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
11
Button

1
8
Name
5
9
nsrdb_all
X
3
345
Y
3
81
Width
3
329
Height
3
24
Tool Tip
5
0
Caption
5
43
TMY or Single-year for Americas and Asia...
TabOrder
3
2
Hyperlink

1
9
Name
5
9
object 14
X
3
690
Y
3
96
Width
3
186
Height
3
24
Tool Tip
5
0
Caption
5
20
Map on NSRDB website
URL
5
169
https://maps.nrel.gov/nsrdb-viewer/#/?aL=j0s5CD%255Bv%255D%3Dt%26e8KZAu%255Bv%255D%3Dt%26e8KZAu%255Bd%255D%3D1&bL=groad&cE=0&lR=0&mC=32.84267363195431%2C-35.5078125&zL=2
TabOrder
3
4294967295
Divider

1
10
Name
5
9
object 22
X
3
18
Y
3
465
Width
3
849
Height
3
16
Tool Tip
5
0
Orientation
3
0
Colour
4
120
120
120
255
Caption
5
16
Files in Library
Bold
2
1
Divider

1
10
Name
5
11
object 2212
X
3
18
Y
3
351
Width
3
645
Height
3
16
Tool Tip
5
0
Orientation
3
0
Colour
4
120
120
120
255
Caption
5
50
Annual Averages Calculated from Weather File  Data
Bold
2
1
Divider

1
10
Name
5
11
object 2213
X
3
18
Y
3
240
Width
3
645
Height
3
16
Tool Tip
5
0
Orientation
3
0
Colour
4
120
120
120
255
Caption
5
29
Header Data from Weather File
Bold
2
1
GroupBox

1
8
Name
5
8
object 4
X
3
9
Y
3
12
Width
3
870
Height
3
138
Tool Tip
5
0
Caption
5
46
NREL National Solar Radiation Database (NSRDB)
Bold
2
1
GroupBox

1
8
Name
5
10
object 417
X
3
9
Y
3
657
Width
3
870
Height
3
105
Tool Tip
5
0
Caption
5
40
Choose a Weather File from Your Computer
Bold
2
1
Label

1
13
Name
5
8
object 7
X
3
15
Y
3
33
Width
3
857
Height
3
42
Tool Tip
5
0
Caption
5
248
Download the latest weather files from the NSRDB to add to your solar resource library: Download a typical-year (TMY) file for most long-term cash flow analyses, or choose files to download for single-year or P50/P90 analyses. See Help for details.
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
4294967295
WordWrap
2
1
AlignRight
2
0
AlignTop
2
1
Label

1
13
Name
5
10
object 715
X
3
24
Y
3
708
Width
3
846
Height
3
45
Tool Tip
5
0
Caption
5
199
Check the box and click Browse to choose a weather file stored on your computer without adding it to the solar resource library. Supported solar weather file formats are SAM CSV, TMY2, TMY3, and EPW.
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
4294967295
WordWrap
2
1
AlignRight
2
0
AlignTop
2
1
Label

1
13
Name
5
10
object 726
X
3
15
Y
3
168
Width
3
846
Height
3
42
Tool Tip
5
0
Caption
5
242
Use the buttons above to download the latest NSRDB files and add them to your solar resource library. Click Folder Settings to add your own weather files to the library. The default library contains legacy weather files. See Help for details.
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
4294967295
WordWrap
2
1
AlignRight
2
0
AlignTop
2
1
Button

1
8
Name
5
22
open_containing_folder
X
3
675
Y
3
321
Width
3
195
Height
3
24
Tool Tip
5
0
Caption
5
30
Open default library folder...
TabOrder
3
6
Button

1
8
Name
5
15
refresh_library
X
3
675
Y
3
291
Width
3
195
Height
3
24
Tool Tip
5
0
Caption
5
15
Refresh library
TabOrder
3
4
Button

1
8
Name
5
19
select_weather_file
X
3
780
Y
3
678
Width
3
90
Height
3
24
Tool Tip
5
0
Caption
5
9
Browse...
TabOrder
3
9
TextEntry

1
11
Name
5
20
solar_data_file_name
X
3
99
Y
3
213
Width
3
763
Height
3
24
Tool Tip
5
0
Text
5
0
Editable
2
0
ForeColour
4
128
0
64
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
Button

1
8
Name
5
19
solar_data_settings
X
3
675
Y
3
258
Width
3
195
Height
3
24
Tool Tip
5
0
Caption
5
18
Folder settings...
TabOrder
3
5
TextEntry

1
11
Name
5
17
solar_data_source
X
3
354
Y
3
321
Width
3
103
Height
3
24
Tool Tip
5
0
Text
5
3
src
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
7
Library

1
8
Name
5
14
solar_resource
X
3
21
Y
3
489
Width
3
846
Height
3
159
Tool Tip
5
0
Library
5
17
SolarResourceData
Fields
5
61
Name,Station ID,Latitude,Longitude,Time zone,Elevation,Source
TextEntry

1
11
Name
5
5
state
X
3
63
Y
3
291
Width
3
97
Height
3
24
Tool Tip
5
0
Text
5
2
AX
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
7
TextEntry

1
11
Name
5
10
station_id
X
3
546
Y
3
321
Width
3
103
Height
3
24
Tool Tip
5
0
Text
5
4
wban
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
7
Numeric

1
17
Name
5
2
tz
X
3
354
Y
3
261
Width
3
103
Height
3
24
Tool Tip
5
0
Value
1
-7.5
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
4
GMT 
Suffix
5
0
ThousandsSep
2
0
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
8
CheckBox

1
9
Name
5
25
use_specific_weather_file
X
3
24
Y
3
678
Width
3
27
Height
3
24
Tool Tip
5
0
Caption
5
0
State
2
0
TabOrder
3
7
TextEntry

1
11
Name
5
27
user_specified_weather_file
X
3
60
Y
3
678
Width
3
711
Height
3
24
Tool Tip
5
0
Text
5
0
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
8

23
annual_beam
3
1
Direct normal (beam)
kWh/m²/day
Location and Resource
0
4
1
1
1
1
0
Numeric
annual_diffuse
3
1
Diffuse horizontal
kWh/m²/day
Location and Resource
0
4
1
1
1
1
0
Numeric
annual_global
3
1
Global horizontal
kWh/m²/day
Location and Resource
0
20
1
1
1
1
0
Numeric
annual_snow
3
1
Maximum snow depth
cm
Location and Resource
0
8
1
1
1
1
0
Default
annual_tdry
3
1
Average temperature
°C
Location and Resource
0
4
1
1
1
1
0
Numeric
annual_wspd
3
1
Average wind speed
m/s
Location and Resource
0
4
1
1
1
1
0
Numeric
city
3
4
City
 
Location and Resource
0
8
1
4
9
<invalid>
TextEntry
country
3
4
Country
 
Location and Resource
0
8
1
4
9
<invalid>
TextEntry
elev
3
1
Elevation
 
Location and Resource
0
8
1
1
1
1
0
Numeric
file_name
3
4
Resource file name
 
Location and Resource
0
9
1
4
0
Default
lat
3
1
Latitude
°N
Location and Resource
0
8
1
1
1
1
0
Numeric
lbl_csp
3
4
 
 
Location and Resource
0
0
1
4
0
Default
lon
3
1
Longitude
°E
Location and Resource
0
8
1
1
1
1
0
Numeric
solar_data_file_name
3
4
Weather file
 
Location and Resource
0
8
1
4
0
TextEntry
solar_data_source
3
4
Data Source
 
Location and Resource
0
8
1
4
0
TextEntry
solar_resource
3
4
Location
 
Location and Resource
19
SolarResourceData|0
19
1
4
21
USA AZ Phoenix (TMY2)
Library
solar_resource_file
3
4
Weather file on disk
 
Location and Resource
0
8
1
4
0
Default
state
3
4
State
 
Location and Resource
0
8
1
4
9
<invalid>
TextEntry
station_id
3
4
Station ID
 
Location and Resource
0
8
1
4
0
TextEntry
tz
3
1
Time zone
 
Location and Resource
0
8
1
1
1
1
0
Numeric
use_specific_weather_file
3
1
Use weather file on disk
 
Location and Resource
0
3
1
1
1
1
0
CheckBox
user_specified_weather_file
3
4
Weather file on disk
 
Location and Resource
0
3
1
4
0
TextEntry
wf_nrecords
3
1
Number of weather file records
 
Location and Resource
0
4
1
1
1
1
8760
Default

275
equations{'solar_resource_file'} = define() {
	if ( ${use_specific_weather_file} ) return ${user_specified_weather_file};
	else return ${solar_data_file_name};
};

equations{'file_name'} = define() {
	// for compatibility with most SSC APIs
	return ${solar_resource_file};
};
10424

on_load{'Solar Resource Data'} = define() {
	on_change{'use_specific_weather_file'}();
	show('annual_snow',technology() == "Flat Plate PV");
	display_csp_message();
};

on_change{'solar_data_file_name'} = define() {

	wf = value('solar_data_file_name');
	if (!file_exists(wf))
	{
		rescanlibrary( 'solar' );
		refresh('solar_resource');
		return;
	}
	
	
	obj = ssc_create();
	ssc_var( obj, 'file_name', wf );
	if ( 0 == ssc_exec( obj, 'wfreader' ) )
	{
		value( 'annual_global', ssc_var(obj, 'annual_glob') );
		value( 'annual_beam', ssc_var(obj, 'annual_beam') );
		value( 'annual_diffuse', ssc_var(obj, 'annual_diff') );
		value( 'annual_tdry', ssc_var(obj, 'annual_tdry') );
		value( 'annual_wspd', ssc_var(obj, 'annual_wspd') );
		value( 'annual_snow', ssc_var(obj, 'annual_snow') );

		// used for timestep calculation in editscene3d
		value( 'wf_nrecords', ssc_var(obj, 'nrecords') );
	}
	else
	{
		value( 'annual_global', nan() );
		value( 'annual_beam', nan() );
		value( 'annual_diffuse', nan() );
		value( 'annual_tdry', nan() );
		value( 'annual_wspd', nan() );
		value( 'annual_snow', nan() );
		value( 'wf_nrecords', nan() );
	}	
	
	ssc_free( obj );
};

on_change{'use_specific_weather_file'} = define() {
	enable( 'user_specified_weather_file', ${use_specific_weather_file} );
	enable( 'select_weather_file', ${use_specific_weather_file} );
};


on_change{'select_weather_file'} = define() {
	file = choose_file( '', 'Choose a weather file', 
		'All Weather Files (*.tm2,*.tm3,*.epw,*.smw,*.csv)|*.tm2;*.tm3;*.epw;*.smw;*.csv');
		
	if ( file != '' ) {
		file = replace(file, '\\', '/');
		value( 'user_specified_weather_file', file );
	}
};

function display_csp_message() 
{
	tech = technology();
	csp_techs = ['Physical Trough','Empirical Trough','MSPT','DSPT','MSLF','DSLF','Dish Stirling','Generic CSP System'];
	is_csp = false;
	for ( i=0; i<#csp_techs; i++ )
		if ( tech == csp_techs[i] )
			is_csp = true;
	show( 'lbl_csp' , is_csp );
}

function download_nsrdb()
{
	msg = 'Use this window to download a typical-year (TMY) file from the NSRDB to a folder on your computer and add it to your solar resource library.\n'
	+'Enter your location as a street address or latitude and longitude, for example:\n'
		+'   15031 denver west parkway golden co\n'
		+'   40.1,-109.3\n\n'
		+'The email address you used to register SAM will be sent to the NSRDB at NREL. If you do not want share your email address with the NSRDB, click Cancel now.';
	
	loc = in( msg, '', 'Download Typical-year (TMY) Weather File from NSRDB' );
	if ( '' == loc ) return '';
	
	is_addr = false;
	len = strlen(loc);
	for( i=0;i<len;i++ )
		if ( isalpha(ch(loc,i)) )
			is_addr = true;
	
	lat = 0;
	lon = 0;
	locname = '';
	if ( is_addr) 
	{
		coords = geocode( loc, 'Geocoding address: ' + loc + '...' );
		if ( typeof(coords) == 'table' )
		{
			lat = to_real(coords.lat);
			lon = to_real(coords.lon);
			
			for( i=0;i<len;i++ )
			{
				C = ch(loc,i);
				if( isalpha(C)
					|| isdigit(C)
					|| C == ','
					|| C == ' '
					|| C == '_' )
					locname += C;
			}			
		}
		else
		{
			msgbox( 'Error translating address to latitude/longitude:\n\n' + loc );
			return '';
		}
	}
	else
	{
		parts = split(loc,',');
		if ( #parts < 2 )
		{
			msgbox( 'Incorrectly formatted latitude, longitude.' );
			return '';
		}
		
		lat = to_real(parts[0]);
		lon = to_real(parts[1]);
		locname = sprintf( 'lat%.5lf_lon%.5lf', lat, lon );
	}
	
	/* new button and window replaces choose options
	options = [ 'TMY' ];
	for( year = 1998; year <= 2014; year++ )
		options[#options] = to_string(year);
		
	dataset = choose_from_list( options, 'Select data set (tmy or specific year):', 'NREL NSRDB', 0 );
	dataset = lower(dataset);
	if ( '' == dataset )
		return '';
	*/
	
	dataset = 'tmy';
	
	url = webapi( 'nsrdb_download' );
	url = replace(url, '<LON>', lon );
	url = replace(url, '<LAT>', lat );
	url = replace(url, '<DATASET>', dataset );
	
	logmsg( url );
	
	/*
	url = 'https://developer.nrel.gov/api/solar/nsrdb_0512_download.csv?'
		+ sprintf( 'wkt=POINT(%g %g)', lon, lat )
		+ '&names=' + dataset
		+ '&leap_day=false&interval=60&utc=false'
		+ '&full_name=sam_user&email=sam.support@nrel.gov'
		+ '&affiliation=nrel&mailing_list=false&reason=SAM'
		+ '&api_key=<SAMAPIKEY>'
		+ '&attributes=dhi,dni,ghi,clearsky_dhi,clearsky_dni,clearsky_ghi,cloud_type,dew_point,surface_air_temperature_nwp,surface_pressure_background,surface_relative_humidity_nwp,solar_zenith_angle,total_precipitable_water_nwp,snow_depth,wind_direction_10m_nwp,wind_speed_10m_nwp,fill_flag';
	*/
		
	wf = wfdownloaddir() + '/' + locname + '_' + dataset + '.csv';
	
	if ( !curl( url, {'file'=wf, 'message'='Downloading NSRDB solar data for: ' + locname + '...' }) )
	{
		msgbox('Error downloading data from the NREL NSRDB');
		return '';
	}
	
	ssc = ssc_create();
	ssc_var( ssc, 'input_file', wf );
	result = ssc_exec( ssc, 'wfcheck', {'show_dialog'=true, 'dialog_title'='Checking weather file...'} );
	ssc_free( ssc );
	
	if ( typeof(result) == 'string' )
	{
		obj = json_read(read_text_file( wf ));	
		msgbox('Error in downloaded weather file data for ' 
			+ locname + ':\n' 
			+ ( (typeof(obj)=='table' && obj ?@ 'errors') ? obj.errors[0] : result ) );
		remove_file( wf );
		return '';
	}
	
	//msgbox('Weather file successfully downloaded:\n\n' + wf );
	
	return wf;
}



// development
function all_nsrdb()
{
	msg = 'Enter your location as a street address or latitude, longitude:\n\n'
		+ 'Examples:\n'
		+'   15031 denver west parkway golden co\n'
		+'   40.1,-109.3\n\n'
		+'The email address you used to register SAM will be sent to the NSRDB at NREL.\n'
		+'If you do not want share your email address with the NSRDB, press Cancel now.';
	
	loc = in( msg, '', 'NREL NSRDB Solar Data Download' );
	if ( '' == loc ) return '';
	
	is_addr = false;
	len = strlen(loc);
	for( i=0;i<len;i++ )
		if ( isalpha(ch(loc,i)) )
			is_addr = true;
	
	lat = 0;
	lon = 0;
	locname = '';
	if ( is_addr) 
	{
		coords = geocode( loc, 'Geocoding address: ' + loc + '...' );
		if ( typeof(coords) == 'table' )
		{
			lat = to_real(coords.lat);
			lon = to_real(coords.lon);
			
			for( i=0;i<len;i++ )
			{
				C = ch(loc,i);
				if( isalpha(C)
					|| isdigit(C)
					|| C == ','
					|| C == ' '
					|| C == '_' )
					locname += C;
			}			
		}
		else
		{
			msgbox( 'Error translating address to latitude/longitude:\n\n' + loc );
			return '';
		}
	}
	else
	{
		parts = split(loc,',');
		if ( #parts < 2 )
		{
			msgbox( 'Incorrectly formatted latitude, longitude.' );
			return '';
		}
		
		lat = to_real(parts[0]);
		lon = to_real(parts[1]);
		locname = sprintf( 'lat%.5lf_lon%.5lf', lat, lon );
	}
	
	
	url = webapi( 'nsrdb_list_all' );
	url = replace(url, '<LON>', lon );
	url = replace(url, '<LAT>', lat );
	
	logmsg( url );
	
	/*
	DEVELOPMENT
	http://maps-stage-api.nrel.gov/solar/nsrdb_data_query.json?wkt=POINT(-81.785+34.8)
	
		
	wf = wfdownloaddir() + '/' + locname + '.json';
	if ( !curl( url, {'file'=wf, 'message'='Downloading solar data options for: ' + locname + '...' }) )
	{
		msgbox('Error downloading data from the NREL NSRDB');
		return '';
	}
	json = json_read(read_text_file( wf ));	
	*/
	
	json=json_read(curl( url, {'message'='Downloading resource options for: ' + locname + '...' }));
	
	msgbox('Options ' + json);
	
	number_links = ((typeof(json)=='table' && json ?@ 'outputs') ? #json.outputs[0].links : 10 );
	
	pb = progressbar( { message="downloading", title="title", cancelbutton=true, time=true, max=number_links} ) ;
	
	for(i=0;i<number_links;i++)
	{
		progressbar(pb, {message=(i+1) + " of " + number_links, value=i+1});
		wf = wfdownloaddir() + '/' + locname + i + '.csv';
		logmsg(wf);
		url = json_read(json.outputs[0]);
		msgbox(url);
		progressbar(pb);
		return '';
		url = replace(url, "yourapikey","<SAMAPIKEY>");
		url = replace(url, "youremail","<USEREMAIL>");
		logmsg(url);
		if ( !curl( url, {'file'=wf, 'message'='Downloading solar data options for: ' + locname + '...' }) )
		{
			msgbox('Error downloading ' + wf + ' data from the NREL NSRDB');
			return '';
		}
	}
	progressbar(pb);
	/*

	options = [ 'TMY' ];
	for( year = 1998; year <= 2014; year++ )
		options[#options] = to_string(year);
		
	dataset = choose_from_list( options, 'Select data set (tmy or specific year):', 'NREL NSRDB', 0 );
	dataset = lower(dataset);
	if ( '' == dataset )
		return '';
	

	wf = wfdownloaddir() + '/' + locname + '_' + dataset + '.csv';


	ssc = ssc_create();
	ssc_var( ssc, 'input_file', wf );
	result = ssc_exec( ssc, 'wfcheck', {'show_dialog'=true, 'dialog_title'='Checking weather file...'} );
	ssc_free( ssc );
	
	if ( typeof(result) == 'string' )
	{
		obj = json_read(read_text_file( wf ));	
		msgbox('Error in downloaded weather file data for ' 
			+ locname + ':\n' 
			+ ( (typeof(obj)=='table' && obj ?@ 'errors') ? obj.errors[0] : result ) );
		remove_file( wf );
		return '';
	}
	
	//msgbox('Weather file successfully downloaded:\n\n' + wf );
	return wf;
	*/
	return "";
}




// latest api 3/17/2017
on_change{'nsrdb_all'} = define() {
	hash = nsrdbquery();
	// meta data
	if ( hash != '' )
	{ 
		fn = hash{'file'};
		dn = hash{'folder'};
		af = hash{'addfolder'};
		if (af == "no")
		{
			if ((fn != '') && (dn != ''))
			{
				value( 'use_specific_weather_file', 1 );
				fn = replace(fn, '\\', '/');
				value( 'user_specified_weather_file', fn );
			}
		}
		else
		{
			rescanlibrary( 'solar' );
			if (fn != '')
			{
				value( 'use_specific_weather_file', 0 );
				libkey = file_only( fn );
				libkey = mid(libkey,0,#libkey-4);		
				value( 'solar_resource', libkey );
			}

		}
	}
};

on_change{'download_weather_file'} = define() {
	wf = download_nsrdb();
	if ( wf != '' )
	{
		value( 'use_specific_weather_file', 0 );
		rescanlibrary( 'solar' );
		libkey = file_only( wf );
		libkey = mid(libkey,0,#libkey-4);		
		value( 'solar_resource', libkey );
		msgbox("Weather data was downloaded successfully from the NREL NSRDB.\n\n" + wf );
	}
};

on_change{'refresh_library'} = define() {
	rescanlibrary('solar');
};

on_change{'solar_data_settings'} = define() {
	if ( showsettings( 'solar' ) )
		rescanlibrary( 'solar' );
};


on_change{'dview_for_solar'} = define() {
	if ( dview_solar(${solar_resource_file}) )
		msgbox("An error occurred when reading the solar data file:\n\n" + 
			${solar_resource_file} );
};

on_change{'open_containing_folder'} = define() {
	browse( path_only(${solar_data_file_name}) );
};
