Battery Voltage
1056
709
19
GroupBox

1
8
Name
5
18
Voltage Properties
X
3
6
Y
3
3
Width
3
1042
Height
3
696
Tool Tip
5
0
Caption
5
18
Voltage Properties
Bold
2
1
Numeric

1
17
Name
5
11
batt_C_rate
X
3
270
Y
3
543
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
5
Numeric

1
17
Name
5
17
batt_Qexp_percent
X
3
270
Y
3
489
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
9
Numeric

1
17
Name
5
17
batt_Qnom_percent
X
3
270
Y
3
516
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
10
Numeric

1
17
Name
5
9
batt_Vcut
X
3
270
Y
3
378
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
8
Numeric

1
17
Name
5
9
batt_Vexp
X
3
270
Y
3
435
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
7
Numeric

1
17
Name
5
10
batt_Vfull
X
3
270
Y
3
462
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
6
Numeric

1
17
Name
5
9
batt_Vnom
X
3
270
Y
3
408
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
8
Label

1
13
Name
5
17
batt_chem_message
X
3
402
Y
3
384
Width
3
624
Height
3
27
Tool Tip
5
0
Caption
5
53
Enter at least two rows of data in the voltage table.
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
0
WordWrap
2
1
AlignRight
2
0
AlignTop
2
1
Divider

1
10
Name
5
20
batt_modeled_voltage
X
3
390
Y
3
357
Width
3
642
Height
3
22
Tool Tip
5
0
Orientation
3
0
Colour
4
120
120
120
255
Caption
5
13
Voltage Table
Bold
2
1
Divider

1
10
Name
5
22
batt_modeled_voltage19
X
3
9
Y
3
357
Width
3
369
Height
3
16
Tool Tip
5
0
Orientation
3
0
Colour
4
120
120
120
255
Caption
5
21
Electrochemical Model
Bold
2
1
Numeric

1
17
Name
5
15
batt_resistance
X
3
183
Y
3
180
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
3
Numeric

1
17
Name
5
20
batt_ui_bank_voltage
X
3
183
Y
3
207
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
0
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
Numeric

1
17
Name
5
20
batt_ui_cell_voltage
X
3
183
Y
3
234
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
0
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
RadioChoice

1
11
Name
5
19
batt_voltage_choice
X
3
27
Y
3
114
Width
3
339
Height
3
54
Tool Tip
5
0
Selection
3
0
Items
6
2
Electrochemical model
Voltage table
ShowCaptions
2
1
Horizontal
2
0
TabOrder
3
4
DataMatrix

1
27
Name
5
19
batt_voltage_matrix
X
3
402
Y
3
417
Width
3
622
Height
3
279
Tool Tip
5
0
PasteAppendRows
2
1
PasteAppendCols
2
0
ShowButtons
2
1
ShowRows
2
1
ShowRowLabels
2
0
RowLabels
5
0
ShadeR0C0
2
0
VerticalLabel
5
0
HorizontalLabel
5
0
ShadeC0
2
0
ShowCols
2
0
ShowColLabels
2
1
ColLabels
5
39
Depth-of-discharge (%),Cell voltage (V)
NumRowsLabel
5
5
Rows:
NumColsLabel
5
5
Cols:
Layout
3
1
ChoiceColumn
3
4294967295
Choices
5
15
Choice1,Choice2
HideColumn
3
4294967295
ShowColumn
3
4294967295
ColorMap
2
0
Plot

1
6
Name
5
17
batt_voltage_plot
X
3
405
Y
3
87
Width
3
622
Height
3
261
Tool Tip
5
0
Label

1
13
Name
5
17
lbl_vanadium_flow
X
3
21
Y
3
570
Width
3
357
Height
3
54
Tool Tip
5
0
Caption
5
0
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
0
WordWrap
2
1
AlignRight
2
0
AlignTop
2
1
Label

1
13
Name
5
8
object 7
X
3
15
Y
3
27
Width
3
1020
Height
3
48
Tool Tip
5
0
Caption
5
370
Choose a model to calculate battery voltage: The  electrochemical model is suitable for Li-ion, lead acid batteries, and Vanadium flow batteries. The voltage table can be used for any battery type, but requires voltage curve data that may not be available on manufacturer data sheets. Use default values for your battery type if you do not have data from another source.
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
0
WordWrap
2
1
AlignRight
2
0
AlignTop
2
1

12
batt_C_rate
3
1
C-rate of discharge curve
 
Battery Voltage
0
2
1
1
1
1
0.1
Default
batt_Qexp_percent
3
1
Charge removed at exponential point
%
Battery Voltage
0
2
1
1
1
1
1
Default
batt_Qnom_percent
3
1
Charge removed at nominal point
%
Battery Voltage
0
2
1
1
1
1
95
Default
batt_Vcut
3
1
Cutoff cell voltage
V
Battery Voltage
0
2
1
1
1
1
1.452
Default
batt_Vexp
3
1
Exponential zone cell voltage
V
Battery Voltage
0
2
1
1
1
1
2.05
Default
batt_Vfull
3
1
Fully charged cell voltage
V
Battery Voltage
0
2
1
1
1
1
2.2
Default
batt_Vnom
3
1
Nominal zone cell voltage
V
Battery Voltage
0
2
1
1
1
1
2.04
Default
batt_resistance
3
1
Cell internal resistance
Ohm
Battery Voltage
0
2
1
1
1
1
0.1
Default
batt_ui_bank_voltage
3
1
Nominal bank voltage
Vdc
Battery Voltage
0
8
1
1
1
1
0
Numeric
batt_ui_cell_voltage
3
1
Nominal cell voltage
Vdc
Battery Voltage
0
8
1
1
1
1
0
Numeric
batt_voltage_choice
3
1
Battery voltage model options
 
Battery Voltage
35
Electrochemical model|Voltage table
1
1
1
1
1
0
RadioChoice
batt_voltage_matrix
3
3
Battery voltage table input
 
Battery Voltage
40
Depth of discharge [%]| Cell voltage [V]
3
1
3
6
2
0 1.2 
20 1.1 
40 1.05 
60 1 
80 0.95 
100 0.5 

DataMatrix

164
equations{'batt_ui_bank_voltage'} = define() 
{ return ${batt_computed_voltage}; };

equations{'batt_ui_cell_voltage'} = define() 
{ return ${batt_Vnom_default}; };
7623
on_load{'Battery Voltage'} = define()
{
	set_voltage_choice( false );
	update_voltage_plot();

	on_change{'batt_voltage_choice'};
	on_change{'batt_C_rate'};
	on_change{'batt_resistance'};
	on_change{'batt_Vfull'};
	on_change{'batt_Vexp'};
	on_change{'batt_Vnom'};
	on_change{'batt_Vcut'};
	on_change{'batt_Qexp_percent'};
	on_change{'batt_Qnom_percent'};
	on_change{'batt_voltage_matrix'};
};

on_change{'batt_voltage_choice'} = define()
{		
	set_voltage_choice( false );
	update_voltage_plot();
};

on_change{'batt_C_rate'} = define(){update_voltage_plot();};
on_change{'batt_resistance'} = define(){update_voltage_plot();};
on_change{'batt_Vfull'} = define(){update_voltage_plot();};
on_change{'batt_Vexp'} = define(){update_voltage_plot();};
on_change{'batt_Vnom'} = define(){update_voltage_plot();};
on_change{'batt_Vcut'} = define(){update_voltage_plot();};
/*on_change{'batt_Vnom_default'} = define()
{
	update_voltage_plot();
	battsize_warning_check();
};*/
on_change{'batt_Qexp_percent'} = define(){update_voltage_plot();};
on_change{'batt_Qnom_percent'} = define(){update_voltage_plot();};
on_change{'batt_voltage_matrix'} = define(){update_voltage_plot();};

// this gets called from Battery Model form when 
// battery type changes
function set_voltage_choice( is_update_default )
{
	// electrochemical not available for iron flow
	// don't need to display message or set voltage choice if updating default
	if ( value('batt_voltage_choice') == 0 && value('batt_chem') == 3 && !is_update_default )
	{
		msgbox('Electrochemical voltage model is not available for iron flow batteries.\nChanging to voltage table.');
		value('batt_voltage_choice',1); 
	}

	msg = '';
	is_electrochemical = value('batt_voltage_choice') == 0;
	is_vanadium_flow = value('batt_chem') == 2;
	enable('batt_voltage_matrix', !is_electrochemical);
	// vanadium flow model only uses nominal voltage as input
	enable('batt_Vnom', is_electrochemical && !is_vanadium_flow);
	enable('batt_Vcut', is_electrochemical && !is_vanadium_flow);
	if (!(is_electrochemical && !is_vanadium_flow))
		value('batt_Vcut', 0);
	enable('batt_C_rate', is_electrochemical && !is_vanadium_flow );
	enable('batt_Vfull', is_electrochemical && !is_vanadium_flow);
	enable('batt_Vexp', is_electrochemical && !is_vanadium_flow);
	enable('batt_Qexp_percent', is_electrochemical && !is_vanadium_flow);
	enable('batt_Qnom_percent', is_electrochemical && !is_vanadium_flow);
	if ( is_vanadium_flow ) { msg = 'The Electrochemical model for Vanadium redox flow batteries requires only the nominal voltage as input. Use the voltage at 50% SOC for the nominal voltage.'; }
	property('lbl_vanadium_flow','Caption',msg);
	/*
	if ( value('batt_voltage_choice') == 0 )
	{
		enable('batt_voltage_matrix', false);
		// batt_Vnom is only input for vanadium flow batteries
		enable('batt_Vnom', true);
		if ( value('batt_chem') == 2 ) 
		{
			enable('batt_C_rate', false);
			enable('batt_Vfull', false);
			enable('batt_Vexp', false);
			enable('batt_Qexp_percent', false);
			enable('batt_Qnom_percent', false);
		}
		else
		{
			enable('batt_C_rate', true);
			enable('batt_Vfull', true);
			enable('batt_Vexp', true);
			enable('batt_Qexp_percent', true);
			enable('batt_Qnom_percent', true);
		}
	}
	else // voltage table
	{
		enable('batt_voltage_matrix', true);
		enable('batt_Vnom', false);
		enable('batt_C_rate', false);
		enable('batt_Vfull', false);
		enable('batt_Vexp', false);
		enable('batt_Qexp_percent', false);
		enable('batt_Qnom_percent', false);
	}*/
}
/*
function show_voltage_model_inputs(show_inputs)
{

	is_vanadium_flow = ( value('batt_chem') == 2);

	show('batt_Vnom', show_inputs && is_vanadium_flow );
	
	msg = '';
	if ( !is_vanadium_flow )
	{
		show('batt_C_rate', show_inputs);
		show('batt_Vfull', show_inputs);
		show('batt_Vexp', show_inputs);
		show('batt_Qexp_percent', show_inputs);
		show('batt_Qnom_percent', show_inputs);
	}
	else
	{
		msg = 'For Vanadium redox flow batteries, enter the voltage at 50% SOC.';
	}
	property('lbl_vanadium_flow','Caption',msg);
}
*/

// enable/disable electrochemical model inputs
/*
function enable_electrochemical_inputs(on)
{
	msg = '';
	// batt_Vnom is only input for vanadium flow batteries
	if ( !value('batt_chem') == 2 ) 
	{
		enable('batt_Vnom', on);
		enable('batt_C_rate', on);
		enable('batt_Vfull', on);
		enable('batt_Vexp', on);
		enable('batt_Qexp_percent', on);
		enable('batt_Qnom_percent', on);
	}
	else
	{
		enable('batt_Vnom', on);
		msg = 'For Vanadium redox flow batteries, enter the voltage at 50% SOC.';
	}
	property('lbl_vanadium_flow','Caption',msg);

	// if electrochemical voltage model not enabled, enable voltage table
	enable('batt_voltage_matrix', !on);
}*/
function update_voltage_plot()
{
	table = cell_voltage_vs_dod();
	Vfull = table{'Vfull'};
	DOD_vect = table{'DOD'};
	V_vect = table{'V'};
	Vcut = value('batt_Vcut');
	clearplot( 'batt_voltage_plot');
	plot( DOD_vect, V_vect, {'thick'=2, 'type'='line', 'color'='blue'});
	plotopt( {'title'='Voltage Discharge', 'legend'=false });
	axis( 'x1', {'label'='Depth of Discharge (%)', 'min'=-0.5, 'max'=100+0.5});
	axis( 'y1', {'label'='Voltage (V)', 'min'=Vcut, 'max'=Vfull+0.1});
	
	// also update calendar life plot, since depends on voltage in model case
	mode = value('batt_calendar_choice');
	if (mode == 1){
		// hack, directly calling plot function results in non-embedded plot
		value('batt_calendar_choice', 2);
		value('batt_calendar_choice', 1);
	}

	
}

function cell_voltage_vs_dod()
{
	voltage_mode = value('batt_voltage_choice');
	DOD_vect = [];
	V_vect = [];
	Vfull = 0;
	
	if (voltage_mode == 0)
	{
		Qfull = ${batt_Qfull};

		Qnom_percent = ${batt_Qnom_percent};
		Qexp_percent = ${batt_Qexp_percent};
		Vfull = ${batt_Vfull};
		Vexp = ${batt_Vexp};
		Vnom = ${batt_Vnom};
		C_rate = ${batt_C_rate};
		eta = 0.995;
		Vcut = ${batt_Vcut};
		
		// strange bug, after simulation Qnom is calculated erroneously
		Qnom = Qnom_percent*Qfull*0.01;
		Qexp = Qexp_percent*Qfull*0.01;
		
		I = Qfull*C_rate;
		R = ${batt_resistance};//Vnom*(1-eta)/(C_rate*Qnom);
		A = Vfull - Vexp;
		B = 3/Qexp;
		K = ((Vfull - Vnom + A*(exp(-B*Qnom) - 1))*(Qfull - Qnom))/(Qnom);
		E0 = Vfull + K + R*I - A;
		C = (-1*Vcut + E0 - R*Qfull + A*(exp(-B*Qfull)))/K;
		x = Qfull / (C - 1);
		refresh();
		Qfull_cutoff = Qfull + x;
		q0 = Qfull;
		V_vect[0] = Vfull;
		t_vect[0] = 0;
		DOD_vect[0] = 0;
		stop = 1000; // just run for 1000 steps, it will cutoff before
		count = 0;

		//logmsg('Vfull: ' + Vfull + ' Vexp: ' + Vexp + ' Vnom: ' + Vnom + ' Qfull: ' + Qfull + ' Qexp: ' + Qexp + ' Qnom: ' + Qnom + 'Qnom_percent: ' + Qnom_percent + ' C: ' + C_rate); 
		//logmsg('A: ' + A + ' B: ' + B + ' K: ' + K + 'R: ' + R + ' EO: ' + E0 ); 

		for (i = 1; i <= stop; i++){
			count++;
			t = i*0.1;
			q0 = Qfull - I*t;
			V = E0 - R*I - K*(Qfull_cutoff/(Qfull_cutoff -I*t))+ A*exp(-B*I*t);
			DOD = (1.-(q0/Qfull))*100;
			//logmsg('t: ' + t + ' V: ' + V + 'DOD: ' + DOD);
			if ( V < Vcut -0.1 || DOD > 101) {
				t = Qfull/I;
				q0 = Qfull - I*t;
				V = E0 - R*I - K*(Qfull_cutoff/(Qfull_cutoff -I*t))+ A*exp(-B*I*t);
				DOD = (1.-(q0/Qfull))*100;
				t_vect[count] = t;
				V_vect[count] = V;
				DOD_vect[count] = DOD;
				break;
			}
			else
			{
				t_vect[count] = t;
				V_vect[count] = V;
				DOD_vect[count] = DOD;
			}
		}
	}
	else
	{
		voltage_matrix = value('batt_voltage_matrix');
		for (r = 0; r != #voltage_matrix; r++)
		{
			row = voltage_matrix[r];
			DOD_vect[r] = row[0];
			V_vect[r] = row[1];
		}
		Vfull = max(V_vect);
	}
	
	table{'DOD'} = DOD_vect;
	table{'V'} = V_vect;
	table{'Vfull'} = Vfull;
	return table;
}