{
    "Name": "Cambium API Data",
    "Width": 859.0,
    "Height": 319.0,
    "FormObjects": {
        "Button": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "btn_cambium_to_lifetime"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 48.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 273.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 340.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 28.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "Download price data"
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": -1.0
                }
            }
        },
        "Choice": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "cambium_location"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 117.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 129.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 271.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Items": {
                    "Type": 6.0,
                    "StringList": ""
                },
                "Selection": {
                    "Type": 3.0,
                    "Integer": -1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": -1.0
                }
            }
        },
        "Choice": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "cambium_location_type"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 117.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 102.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 271.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Items": {
                    "Type": 6.0,
                    "StringList": ""
                },
                "Selection": {
                    "Type": 3.0,
                    "Integer": -1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": -1.0
                }
            }
        },
        "Choice": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "cambium_metric"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 120.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 210.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 268.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Items": {
                    "Type": 6.0,
                    "StringList": "Cost: End Use Energy [$/MWh]|Cost: End Use Capacity [$/MWh]"
                },
                "Selection": {
                    "Type": 3.0,
                    "Integer": -1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": -1.0
                }
            }
        },
        "Choice": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "cambium_scenario"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 120.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 237.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 268.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": "Choose a scenario"
                },
                "Items": {
                    "Type": 6.0,
                    "StringList": ""
                },
                "Selection": {
                    "Type": 3.0,
                    "Integer": -1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": -1.0
                }
            }
        },
        "Choice": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "cambium_start_year"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 288.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 183.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 100.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Items": {
                    "Type": 6.0,
                    "StringList": ""
                },
                "Selection": {
                    "Type": 3.0,
                    "Integer": 0.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": -1.0
                }
            }
        },
        "Choice": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "cambium_year"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 117.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 156.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 271.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Items": {
                    "Type": 6.0,
                    "StringList": ""
                },
                "Selection": {
                    "Type": 3.0,
                    "Integer": -1.0
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": -1.0
                }
            }
        },
        "Divider": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "object 21"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 15.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 81.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 342.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 16.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Orientation": {
                    "Type": 3.0,
                    "Integer": 0.0
                },
                "Colour": {
                    "Type": 4.0,
                    "Color": {
                        "Red": 120.0,
                        "Green": 120.0,
                        "Blue": 120.0,
                        "Alpha": 255.0
                    }
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "Cambium API Parameters"
                },
                "Bold": {
                    "Type": 2.0,
                    "Boolean": 1.0
                }
            }
        },
        "GroupBox": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "object 4"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 6.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 3.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 850.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 313.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "NREL Cambium Hourly Price Data Download"
                },
                "Bold": {
                    "Type": 2.0,
                    "Boolean": 1.0
                }
            }
        },
        "Label": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "object 7"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 15.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 30.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 834.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 45.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Caption": {
                    "Type": 5.0,
                    "String": "NREL's Cambium database provides hourly marginal cost data for modeled futures of the U.S. electricity sector. This data may be suitable as approximations of market prices for the energy market or ancillary services to use with SAM's Merchant Plant financial model. See Help for details."
                },
                "TextColour": {
                    "Type": 4.0,
                    "Color": {
                        "Red": 0.0,
                        "Green": 0.0,
                        "Blue": 0.0,
                        "Alpha": 255.0
                    }
                },
                "Bold": {
                    "Type": 2.0,
                    "Boolean": 0.0
                },
                "FontSize": {
                    "Type": 3.0,
                    "Integer": 0.0
                },
                "WordWrap": {
                    "Type": 2.0,
                    "Boolean": 1.0
                },
                "AlignRight": {
                    "Type": 2.0,
                    "Boolean": 0.0
                },
                "AlignTop": {
                    "Type": 2.0,
                    "Boolean": 1.0
                }
            }
        },
        "ToolTipCtrl": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "tt_cambium_location"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 390.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 129.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 36.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Tips": {
                    "Type": 5.0,
                    "String": ""
                },
                "TipTitle": {
                    "Type": 5.0,
                    "String": ""
                }
            }
        },
        "ToolTipCtrl": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "tt_cambium_location_type"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 390.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 102.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 36.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Tips": {
                    "Type": 5.0,
                    "String": ""
                },
                "TipTitle": {
                    "Type": 5.0,
                    "String": ""
                }
            }
        },
        "ToolTipCtrl": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "tt_cambium_metric"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 390.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 210.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 36.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Tips": {
                    "Type": 5.0,
                    "String": ""
                },
                "TipTitle": {
                    "Type": 5.0,
                    "String": ""
                }
            }
        },
        "ToolTipCtrl": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "tt_cambium_scenario"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 390.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 237.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 36.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Tips": {
                    "Type": 5.0,
                    "String": ""
                },
                "TipTitle": {
                    "Type": 5.0,
                    "String": ""
                }
            }
        },
        "ToolTipCtrl": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "tt_cambium_year"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 390.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 156.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 36.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 24.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Tips": {
                    "Type": 5.0,
                    "String": ""
                },
                "TipTitle": {
                    "Type": 5.0,
                    "String": ""
                }
            }
        },
        "MultilineText": {
            "Visible": 1.0,
            "ObjectProperties": {
                "Name": {
                    "Type": 5.0,
                    "String": "txt_instructions"
                },
                "X": {
                    "Type": 3.0,
                    "Integer": 429.0
                },
                "Y": {
                    "Type": 3.0,
                    "Integer": 90.0
                },
                "Width": {
                    "Type": 3.0,
                    "Integer": 423.0
                },
                "Height": {
                    "Type": 3.0,
                    "Integer": 207.0
                },
                "Tool Tip": {
                    "Type": 5.0,
                    "String": ""
                },
                "Text": {
                    "Type": 5.0,
                    "String": ""
                },
                "Editable": {
                    "Type": 2.0,
                    "Boolean": 0.0
                },
                "ForeColour": {
                    "Type": 4.0,
                    "Color": {
                        "Red": 0.0,
                        "Green": 0.0,
                        "Blue": 0.0,
                        "Alpha": 255.0
                    }
                },
                "BackColour": {
                    "Type": 4.0,
                    "Color": {
                        "Red": 255.0,
                        "Green": 255.0,
                        "Blue": 255.0,
                        "Alpha": 255.0
                    }
                },
                "TabOrder": {
                    "Type": 3.0,
                    "Integer": -1.0
                }
            }
        }
    },
    "VarDatabase": {
        "cambium_location": {
            "Version": 4.0,
            "Type": 4.0,
            "Label": "Location",
            "Units": " ",
            "Group": "Cambium Download",
            "IndexLabels": "",
            "Flags": 0.0,
            "DefaultValue": "",
            "UIObject": "Choice",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "cambium_location_type": {
            "Version": 4.0,
            "Type": 4.0,
            "Label": "Location type",
            "Units": " ",
            "Group": "Cambium Download",
            "IndexLabels": "",
            "Flags": 0.0,
            "DefaultValue": "",
            "UIObject": "Choice",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "cambium_meta_output": {
            "Version": 4.0,
            "Type": 4.0,
            "Label": " ",
            "Units": " ",
            "Group": "Cambium Download",
            "IndexLabels": "",
            "Flags": 0.0,
            "DefaultValue": "",
            "UIObject": "Default",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "cambium_metric": {
            "Version": 4.0,
            "Type": 4.0,
            "Label": "Metric",
            "Units": " ",
            "Group": "Cambium Download",
            "IndexLabels": "",
            "Flags": 0.0,
            "DefaultValue": "",
            "UIObject": "Choice",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "cambium_scenario": {
            "Version": 4.0,
            "Type": 4.0,
            "Label": "Scenario",
            "Units": " ",
            "Group": "Cambium Download",
            "IndexLabels": "",
            "Flags": 0.0,
            "DefaultValue": "",
            "UIObject": "Choice",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "cambium_start_year": {
            "Version": 4.0,
            "Type": 1.0,
            "Label": "Start year for multiple year option",
            "Units": " ",
            "Group": "Cambium Download",
            "IndexLabels": "",
            "Flags": 0.0,
            "DefaultValue": 0.0,
            "UIObject": "Choice",
            "sscVariableName": "",
            "sscVariableValue": ""
        },
        "cambium_year": {
            "Version": 4.0,
            "Type": 4.0,
            "Label": "Year",
            "Units": " ",
            "Group": "Cambium Download",
            "IndexLabels": "",
            "Flags": 0.0,
            "DefaultValue": "0",
            "UIObject": "Choice",
            "sscVariableName": "",
            "sscVariableValue": ""
        }
    },
    "Equations": [],
    "Callbacks": [
        "on_load{'Cambium API Data'} = define() {",
        "\t// meta url\r",
        "\t// to update to newer version of API, \r",
        "\t// change UUID parameter of URL in webapis.con",
        "\tglobal url_meta = webapi('cambium');\r",
        "\t\r",
        "\t// parse meta url to get UUID and query url\r",
        "\tx = split(url_meta, '?');\r",
        "\tglobal project_uuid = split(x[1],'=')[1];\t\r",
        "\tglobal url_query = replace(x[0],'project/detail','load_data');\r",
        "\t\r",
        "\tglobal api_meta_json = {};",
        "\tglobal global_years = [];",
        "",
        "\t// UI option globals",
        "\tglobal cambium_enable = true;",
        "\tglobal dynamic_option = 'Multiple years';\t// dynamic year option text",
        "",
        "\t// api globals for storing both the option and the description",
        "\tglobal api_metrics = {};",
        "\tglobal api_scenarios = {};",
        "\t",
        "\t// global matrix for the data target map from the choice widget",
        "\tglobal cambium_target = [['mp_enable_energy_market_revenue','mp_energy_market_revenue',",
        "\t\t\t\t\t\t\t\t'mp_enable_market_percent_gen','mp_energy_market_revenue_single','Energy Market'],",
        "\t\t\t\t\t\t\t\t['mp_enable_ancserv1','mp_ancserv1_revenue',",
        "\t\t\t\t\t\t\t\t'mp_enable_ancserv1_percent_gen','mp_ancserv1_revenue_single','Ancillary Service 1'],",
        "\t\t\t\t\t\t\t\t['mp_enable_ancserv2','mp_ancserv2_revenue',",
        "\t\t\t\t\t\t\t\t'mp_enable_ancserv2_percent_gen','mp_ancserv2_revenue_single','Ancillary Service 2'],",
        "\t\t\t\t\t\t\t\t['mp_enable_ancserv3','mp_ancserv3_revenue',",
        "\t\t\t\t\t\t\t\t'mp_enable_ancserv3_percent_gen','mp_ancserv3_revenue_single','Ancillary Service 3'],",
        "\t\t\t\t\t\t\t\t['mp_enable_ancserv4','mp_ancserv4_revenue',",
        "\t\t\t\t\t\t\t\t'mp_enable_ancserv4_percent_gen','mp_ancserv4_revenue_single','Ancillary Service 4']];",
        "",
        "\t// make an api call",
        "\tapi_call = '0';",
        "\tif ( value('cambium_meta_output') == '' )",
        "\t{",
        "\t\tapi_call = curl(url_meta);\r",
        "\t}",
        "\r",
        "\t// if curl fails",
        "\tif( api_call == 0 && cambium_enable)",
        "\t{",
        "\t\tcambium_enable = false;",
        "\t\tmsgbox('Cambium Error\\nA problem with your internet connection or the Cambium API\\n'",
        "\t\t\t + 'is preventing SAM from downloading Cambium data.\\n\\n' ",
        "\t\t\t + 'Cambium inputs will be disabled until the problem is resolved.');",
        "\t}",
        "\telseif(value('cambium_meta_output') == '' )",
        "\t{",
        "\t\tvalue('cambium_meta_output',api_call);",
        "\t}\t",
        "",
        "\t// if html response",
        "\tif(ch(value('cambium_meta_output'),0) == '<' || ch(value('cambium_meta_output'),1) == '<')",
        "\t{",
        "\t\tdisplay_cambium_error(value('cambium_meta_output'));",
        "\t}",
        "\telseif(cambium_enable)",
        "\t{",
        "\t\tapi_meta_json = json_read(value('cambium_meta_output'));",
        "\t\t// if json html response",
        "\t\tif(strcmp((@api_meta_json)[0],'message') == 0 && #api_meta_json == 1)",
        "\t\t{",
        "\t\t\tdisplay_cambium_error(api_meta_json.message);",
        "\t\t}",
        "\t\t// normal json response",
        "\t\telse",
        "\t\t{",
        "\t\t\t// create scenario selection",
        "\t\t\tapi_scenarios = get_api_json('scenarios');",
        "\t\t\t",
        "\t\t\t// create metrics selection",
        "\t\t\tfor(i=0;i<#api_meta_json.meta.metrics;i++)",
        "\t\t\t\t// only keep cost options",
        "\t\t\t\tif(strcmp(left(api_meta_json.meta.metrics[i][0],4),'Cost') == 0)",
        "\t\t\t\t\tapi_metrics{api_meta_json.meta.metrics[i][0]} = api_meta_json.meta.metrics[i][2];",
        "",
        "\t\t\tfor(i=0;i<#api_meta_json.meta.years; i++)",
        "\t\t\t\t\tyears[i] = api_meta_json.meta.years[i][0];",
        "\t\t\t",
        "\t\t\t// retain years without dynamic option",
        "\t\t\tglobal_years = years;\t",
        "\t\t\t",
        "\t\t\t// add dynamic option if feasible",
        "\t\t\tif(value('analysis_period')<2*(#years))",
        "\t\t\t\tyears[#years] = dynamic_option;",
        "\t\t\t",
        "\t\t\t// update choice fields",
        "\t\t\tproperty('cambium_location_type','Items',@api_meta_json.meta.locations);",
        "\t\t\tproperty('cambium_scenario','Items',@api_scenarios);",
        "\t\t\tproperty('cambium_metric','Items',@api_metrics);",
        "\t\t\tproperty('cambium_year','Items',years);",
        "\t\t\tproperty('btn_cambium_to_lifetime','Caption','Download to '+cambium_target[value('revenue_tab')][4]);",
        "\t\t}",
        "\t}",
        "",
        "    txt = '1. Choose Cambium API parameters from the lists at left.\\n\\n' +",
        "        '2. Click the Energy Market or one of the Ancillary Service tabs below.\\n\\n' +",
        "        '3. Enable the energy market or ancillary service, and choose either the Cleared Capacity and Price or Price option.' +",
        "        ' (The Cambium database has price data but not cleared capacity data.)\\n\\n' +",
        "        '4. Click the Download button.\\n\\n' +\r",
        "        'To use the mulitple year option, set the analysis period on the Financial Parameters page less than or equal to the number of available Cambium years, and choose Multiple Years for the year.\\n\\n' + ",
        "        'See Help for details.';",
        "\tproperty('txt_instructions','Text',txt);",
        "\tenable('cambium_location', value('cambium_location_type') != '');",
        "\tupdate_tips();",
        "\ton_change{'cambium_location_type'}();",
        "\tupdate_dynamic_years();",
        "\tupdate_submission_btn();",
        "\t",
        "\trefresh();",
        "};",
        "",
        "get_api_json = define(key) {",
        "\treturn_json = {};",
        "\t// initialize json of descriptions mapped to the objects they describe",
        "\tfor(i=0;i<#api_meta_json.meta{key};i++)",
        "\t\treturn_json{api_meta_json.meta{key}[i][0]} = api_meta_json.meta{key}[i][2];",
        "\t",
        "\treturn return_json;",
        "};",
        "",
        "on_change{'cambium_location_type'} = define() {",
        "\tif(cambium_enable)",
        "\t{",
        "\t\tlocation_type = value('cambium_location_type');",
        "\t\t",
        "\t\tif( in_array(location_type,@api_meta_json.meta.locations) )",
        "\t\t{",
        "\t\t\t// extract locations from the metadata based on type field",
        "\t\t\tfor(i=0;i<#api_meta_json.meta.locations{location_type}; i++)",
        "\t\t\t\tlocations[i] = api_meta_json.meta.locations{location_type}[i][0];",
        "\t\t\t",
        "\t\t\tproperty('cambium_location','Items',locations);",
        "\t\t\tenable('cambium_location',true);",
        "\t\t\trefresh();",
        "\t\t}",
        "\t\telse",
        "\t\t\tenable('cambium_location',false);",
        "\t\t",
        "\t\tupdate_submission_btn();",
        "\t}",
        "};",
        "",
        "on_change{'cambium_scenario'} = define() {",
        "\tupdate_tips();",
        "\tupdate_submission_btn();",
        "};",
        "",
        "on_change{'cambium_metric'} = define() {",
        "\tupdate_tips();",
        "\tupdate_submission_btn();",
        "};",
        "",
        "update_tips = define() {",
        "\tproperty('tt_cambium_scenario','TipTitle','Scenario Description from Cambium API');",
        "\tproperty('tt_cambium_scenario','Tips',${cambium_scenario} + ': ' + api_scenarios{value('cambium_scenario')});",
        "\tproperty('tt_cambium_metric','TipTitle','Metric Description from Cambium API');",
        "\tproperty('tt_cambium_metric','Tips',${cambium_metric} + ': ' + api_metrics{value('cambium_metric')});",
        "};",
        "",
        "// update submission button enable regardless of which input is filled last",
        "on_change{'cambium_location'} = define() {",
        "\tupdate_submission_btn();",
        "};",
        "",
        "on_change{'cambium_year'} = define() {",
        "\tupdate_dynamic_years();",
        "\tupdate_submission_btn();",
        "\trefresh();",
        "};",
        "",
        "// enable submission button if all requirements are met",
        "update_submission_btn = define() {",
        "\tenable('btn_cambium_to_lifetime', ",
        "\t   value('cambium_location_type') != ''",
        "\t\t&& value('cambium_location') != ''",
        "\t\t&& value('cambium_metric') != ''",
        "\t\t&& value('cambium_scenario') != ''",
        "\t\t&& ((value('cambium_year') != '' && value('cambium_year') != dynamic_option)",
        "\t\t|| (value('cambium_year') == dynamic_option && #property('cambium_start_year','Items')>0))",
        "\t\t&& cambium_enable);",
        "};",
        "",
        "// when submission button is pressed, API call is made ",
        "on_change{'btn_cambium_to_lifetime'} = define() {",
        "\tif(!value(cambium_target[value('revenue_tab')][0]))",
        "\t{",
        "\t\tmsgbox('Cambium Error\\nEnable ' + cambium_target[value('revenue_tab')][4] + ' before downloading.');",
        "\t\treturn;",
        "\t}",
        "\t",
        "\tif(value('cambium_year') == dynamic_option)",
        "\t{",
        "\t\tdynamic_cambium_download();",
        "\t}",
        "\telse",
        "\t{",
        "\t\tnormal_cambium_download();",
        "\t}\t",
        "};",
        "",
        "// download data for multiple years to increment throughout the analysis period",
        "dynamic_cambium_download = define() {",
        "\tyear_idx = to_int(value('cambium_start_year'));",
        "\tpb = progressbar({",
        "\t\t\t\t\t\t'title' = 'API Call Progress',",
        "\t\t\t\t\t\t'message' = 'Making API call for '+global_years[year_idx],",
        "\t\t\t\t\t\t'cancelbutton' = true,",
        "\t\t\t\t\t\t'closebutton' = false,",
        "\t\t\t\t\t\t'time' = false,",
        "\t\t\t\t\t\t'max' = 2*to_int(value(\"analysis_period\"))+1",
        "\t\t\t\t\t});",
        "\t\t\t\t\t",
        "\t// Copy into either the price-only matrix or the 2-col matrix for this target selection",
        "\tif(value(cambium_target[value('revenue_tab')][2]))",
        "\t{",
        "\t\tprice_index = 0;\t// copy price into first column",
        "\t\tvariable_name_index = 3;",
        "\t}",
        "\telse",
        "\t{",
        "\t\tprice_index = 1; \t// copy price in to second column",
        "\t\tvariable_name_index = 1;",
        "\t}",
        "\t// copy the existing data matrix to copy to it (one of the columns may already have data)",
        "\tdata_matrix = value(cambium_target[value('revenue_tab')][variable_name_index]);",
        "\t",
        "\tfor(i=0;i<to_int(value(\"analysis_period\"));i++)",
        "\t{",
        "\t\tyear_string = to_string(global_years[year_idx+i/2]);",
        "\t\teven_bool = ((i-to_int(i/2)*2) == 0);",
        "\t\t",
        "\t\t// if i is even, make an api call",
        "\t\tif(even_bool)",
        "\t\t{",
        "\t\t\tprogressbar(pb, {'message' = 'Making API call for '+year_string+'...','value' = 2*i});",
        "\t\t\tapi_curl_output = cambium_api_call(global_years[year_idx+i/2]);",
        "\t\t\t",
        "\t\t\t// if curl fails",
        "\t\t\tif(api_curl_output == 0)",
        "\t\t\t{",
        "\t\t\t\tcambium_enable = false;",
        "\t\t\t\tmsgbox('Cambium Error\\nNo internet or problem connecting to Cambium API. The Download button will be disabled until the problem is resolved.');",
        "\t\t\t\tupdate_submission_btn();",
        "\t\t\t\tprogressbar(pb);",
        "\t\t\t\treturn;",
        "\t\t\t}",
        "\t\t\t// if html response",
        "\t\t\tif(ch(api_curl_output,0) == '<' || ch(api_curl_output,1) == '<')",
        "\t\t\t{",
        "\t\t\t\tprogressbar(pb);",
        "\t\t\t\tdisplay_cambium_error(api_curl_output);",
        "\t\t\t\treturn;",
        "\t\t\t}",
        "\t\t\t",
        "\t\t\tapi_data_json = json_read(api_curl_output);",
        "\t\t\t// if json html response",
        "\t\t\tif(strcmp((@api_data_json)[0],'message') == 0 && #api_data_json == 1)",
        "\t\t\t{",
        "\t\t\t\tprogressbar(pb);",
        "\t\t\t\tdisplay_cambium_error(api_data_json.message);",
        "\t\t\t\treturn;",
        "\t\t\t}",
        "\t\t} else ",
        "\t\t\tyear_string += ' duplicate';",
        "\t\t\t",
        "\t\tpb_canceled = progressbar(pb, {'message' = 'Copying hourly data for '+year_string+'...','value' = 2*i+1});",
        "\t\tfor(j=0;j<#api_data_json.data.layers[0].y;j++)",
        "\t\t{",
        "\t\t\tdata_matrix[i*#api_data_json.data.layers[0].y+j][price_index]=api_data_json.data.layers[0].y[j];",
        "\t\t}",
        "\t\tif(pb_canceled)",
        "\t\t{",
        "\t\t\tprogressbar(pb);",
        "\t\t\treturn;",
        "\t\t}",
        "\t}",
        "\tprogressbar(pb, {'message' = 'Setting lifetime data...','value' = 2*value(\"analysis_period\")});",
        "\t\t\t\t",
        "\t// force mode change to hourly",
        "\tproperty(cambium_target[value('revenue_tab')][variable_name_index],'Mode','Hourly');",
        "\tvalue(cambium_target[value('revenue_tab')][variable_name_index],data_matrix);",
        "\t",
        "\tprogressbar(pb);",
        "\t",
        "};",
        "",
        "// download data for a single year repeated over the duration of the analysis period",
        "normal_cambium_download = define() {",
        "\tpb = progressbar({",
        "\t\t\t\t\t\t'title' = 'API Call Progress',",
        "\t\t\t\t\t\t'message' = 'Making API call...',",
        "\t\t\t\t\t\t'cancelbutton' = true,",
        "\t\t\t\t\t\t'closebutton' = false,",
        "\t\t\t\t\t\t'time' = false,",
        "\t\t\t\t\t\t'max' = 2*value(\"analysis_period\")+1",
        "\t\t\t\t\t});",
        "",
        "\tapi_curl_output = cambium_api_call(value('cambium_year'));",
        "\t// if curl fails",
        "\tif(api_curl_output == 0)",
        "\t{",
        "\t\tcambium_enable = false;",
        "\t\tmsgbox('Cambium Error\\nNo internet or problem connecting to Cambium API. The Download button will be disabled until the problem is resolved.');",
        "\t\tupdate_submission_btn();",
        "\t\tprogressbar(pb);",
        "\t}",
        "\t// if html response",
        "\telse if(ch(api_curl_output,0) == '<' || ch(api_curl_output,1) == '<')",
        "\t{",
        "\t\tprogressbar(pb);",
        "\t\tdisplay_cambium_error(api_curl_output);",
        "\t}",
        "\telse",
        "\t{",
        "\t\tapi_data_json = json_read(api_curl_output);",
        "\t\t// if json html response",
        "\t\tif(strcmp((@api_data_json)[0],'message') == 0 && #api_data_json == 1)",
        "\t\t{",
        "\t\t\tprogressbar(pb);",
        "\t\t\tdisplay_cambium_error(api_data_json.message);",
        "\t\t}",
        "\t\t// if normal json response",
        "\t\telse",
        "\t\t{",
        "\t\t\t// load into either the price-only matrix or the 2-col matrix for this target selection",
        "\t\t\tif(value(cambium_target[value('revenue_tab')][2]))",
        "\t\t\t{",
        "\t\t\t\tprice_index = 0;\t// copy price into first column",
        "\t\t\t\tvariable_name_index = 3;",
        "\t\t\t}",
        "\t\t\telse",
        "\t\t\t{",
        "\t\t\t\tprice_index = 1; \t// copy price in to second column",
        "\t\t\t\tvariable_name_index = 1;",
        "\t\t\t}",
        "\t\t\t// copy the existing data matrix to copy to it (one of the columns may already have data)",
        "\t\t\tdata_matrix = value(cambium_target[value('revenue_tab')][variable_name_index]);",
        "\t\t\tprogressbar(pb, {'message' = 'Copying hourly data...','value' = value(\"analysis_period\")-1});",
        "\t\t\t",
        "\t\t\tfor(i=0;i<to_int(value(\"analysis_period\"));i++)",
        "\t\t\t{",
        "\t\t\t\tfor(j=0;j<#api_data_json.data.layers[0].y;j++)",
        "\t\t\t\t{",
        "\t\t\t\t\tdata_matrix[i*#api_data_json.data.layers[0].y+j][price_index]=api_data_json.data.layers[0].y[j];",
        "\t\t\t\t}",
        "\t\t\t\tpb_canceled = progressbar(pb, {'value' = to_int(value(\"analysis_period\"))+i});",
        "\t\t\t\tif(pb_canceled)",
        "\t\t\t\t{",
        "\t\t\t\t\tprogressbar(pb);",
        "\t\t\t\t\treturn;",
        "\t\t\t\t}",
        "\t\t\t}",
        "\t\t\t",
        "\t\t\tprogressbar(pb, {'message' = 'Setting lifetime data...','value' = 2*value(\"analysis_period\")});",
        "\t\t\t",
        "\t\t\t// force mode change to hourly",
        "\t\t\tproperty(cambium_target[value('revenue_tab')][variable_name_index],'Mode','Hourly');",
        "\t\t\tvalue(cambium_target[value('revenue_tab')][variable_name_index],data_matrix);",
        "\t\t\t",
        "\t\t\tprogressbar(pb);",
        "\t\t}",
        "\t}",
        "};",
        "",
        "// submit the API call with the gathered data",
        "cambium_api_call = define(year) {",
        "\tinput_json = {",
        "\t\t'location': value('cambium_location'),",
        "\t\t'location_type': value('cambium_location_type'),",
        "\t\t'metric': value('cambium_metric'),",
        "\t\t'scenario': value('cambium_scenario'),",
        "\t\t'scenario_diff': null,",
        "\t\t'technology': 'ALL',",
        "\t\t'technology_type': 'Technologies',",
        "\t\t'year': year",
        "\t};",
        "\tpost_data = {",
        "\t\t'project_uuid': project_uuid,",
        "\t\t'inputs': input_json,",
        "\t\t'x_axis': 'interval'",
        "\t};\r",
        "\treturn curl(url_query,{\"post\":json_write(post_data)});",
        "};",
        "",
        "// calculate the possible start years for the incremental option",
        "update_dynamic_years = define() {",
        "\tif(value('cambium_year') == dynamic_option)",
        "\t{",
        "\t\tyears = [];",
        "\t\t// only show years up to what is supported in cambium based on analysis period",
        "\t\tfor(i=0;i<#api_meta_json.meta.years-value('analysis_period')/2; i++)",
        "\t\t\tyears[i] = api_meta_json.meta.years[i][0];",
        "\t\tproperty('cambium_start_year','Items',years);",
        "\t}",
        "\t",
        "\titems_present = #property('cambium_start_year','Items')>0;",
        "\tenable('cambium_start_year',value('cambium_year') == dynamic_option && items_present);",
        "};",
        "",
        "// show html dialog errors returned from the API",
        "display_cambium_error = define(s) {",
        "\thtml_dialog(s,'Cambium Error from API',[600,400],true);",
        "};",
        "",
        "// true if item is in array",
        "in_array = define(item,array) {",
        "\tfor(i=0;i<#array;i++)",
        "\t\tif(item == array[i])",
        "\t\t\treturn true;",
        "\treturn false;",
        "};"
    ]
}